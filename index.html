<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniteCanva - CreateWithoutBoundry</title>
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #e5e5e5;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        /* CanvasåŒºåŸŸ */
        .canvas-container {
            width: 100%;
            height: 100%;
            background: #e5e5e5;
            position: relative;
        }

        /* Excelè¡¨æ ¼å®¹å™¨ */
        .excel-container {
            position: absolute;
            left: 40px;
            top: 80px;
            width: 32%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-height: 70vh;
            overflow: hidden; /* å®¹å™¨æœ¬èº«ä¸æ»šåŠ¨ */
            cursor: move;
            user-select: none;
            z-index: 10; /* Excelå®¹å™¨å±‚çº§æœ€ä½ */
        }

        /* éšè—Excelå®¹å™¨æ»šåŠ¨æ¡ */
        .excel-container::-webkit-scrollbar {
            width: 0px;
            background: transparent;
            display: none; /* Chrome, Safari, Opera */
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .excel-table th {
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .excel-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
        }

        .excel-table tr:hover {
            background: #f8f9fa;
        }

        .search-query {
            font-weight: 500;
        }

        .search-frequency {
            text-align: right;
            font-weight: 600;
            color: #0066cc;
        }

        .excel-container:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        /* Wordæ–‡æ¡£å®¹å™¨ */
        .word-container {
            position: absolute;
            left: 34%;
            top: 80px;
            width: 32%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: none;
            max-height: 70vh;
            overflow: hidden;
            padding: 20px;
            cursor: move;
            user-select: none;
            z-index: 20; /* Wordå®¹å™¨å±‚çº§ä¸­ç­‰ */
        }

        .word-container:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .dragging {
            z-index: 1000; /* æ‹–æ‹½æ—¶æœ€é«˜å±‚çº§ */
            transform: rotate(2deg);
            opacity: 0.9;
        }

        /* é€‰ä¸­çŠ¶æ€çš„æ ·å¼ */
        .selected {
            border: 3px solid #007bff;
            box-shadow: 0 6px 30px rgba(0, 123, 255, 0.3);
        }

        /* è°ƒæ•´å¤§å°åŠŸèƒ½æ ·å¼ */
        .resizable {
            resize: both;
            overflow: auto;
            min-width: 200px;
            min-height: 150px;
        }

        /* è°ƒæ•´å¤§å°æ‰‹æŸ„æ ·å¼ */
        .resize-handle {
            position: absolute;
            background: transparent; /* å®Œå…¨é€æ˜èƒŒæ™¯ */
            opacity: 0; /* å®Œå…¨é€æ˜ */
            transition: none; /* ç§»é™¤è¿‡æ¸¡æ•ˆæœ */
        }

        .resize-handle:hover {
            opacity: 0; /* æ‚¬åœæ—¶ä¹Ÿä¿æŒé€æ˜ */
            background: transparent; /* ç¡®ä¿èƒŒæ™¯é€æ˜ */
        }

        .selected .resize-handle {
            opacity: 0; /* é€‰ä¸­æ—¶ä¹Ÿä¿æŒé€æ˜ */
            background: transparent; /* ç¡®ä¿èƒŒæ™¯é€æ˜ */
        }

        .selected .resize-handle:hover {
            opacity: 0; /* é€‰ä¸­ä¸”æ‚¬åœæ—¶ä¹Ÿä¿æŒé€æ˜ */
            background: transparent; /* ç¡®ä¿èƒŒæ™¯é€æ˜ */
        }

        /* è°ƒæ•´å¤§å°æ—¶éšè—æ‰‹æŸ„ */
        .resizing .resize-handle {
            opacity: 0 !important;
            background: transparent !important;
        }

        /* è°ƒæ•´å¤§å°æ—¶éšè—é€‰ä¸­è¾¹æ¡† */
        .resizing.selected {
            border: none !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
        }

        /* å³ä¸‹è§’è°ƒæ•´å¤§å°æ‰‹æŸ„ */
        .resize-handle-se {
            width: 15px;
            height: 15px;
            bottom: 0;
            right: 0;
            cursor: se-resize;
        }

        /* å³è¾¹è°ƒæ•´å¤§å°æ‰‹æŸ„ */
        .resize-handle-e {
            width: 5px;
            height: 100%;
            top: 0;
            right: 0;
            cursor: e-resize;
        }

        /* åº•éƒ¨è°ƒæ•´å¤§å°æ‰‹æŸ„ */
        .resize-handle-s {
            width: 100%;
            height: 5px;
            bottom: 0;
            left: 0;
            cursor: s-resize;
        }

        /* æ–‡æ¡£å¤é€‰æ¡†æ ·å¼ */
        .document-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        /* Excelå¤é€‰æ¡†å±‚çº§ */
        .excel-container .document-checkbox {
            z-index: 15; /* Excelå¤é€‰æ¡† */
            top: 13px; /* ä¸å·¥å…·æ ä¸­çš„Microsoft Excelæ–‡å­—å‚ç›´å¯¹é½ */
        }

        /* Wordå¤é€‰æ¡†å±‚çº§ */
        .word-container .document-checkbox {
            z-index: 25; /* Wordå¤é€‰æ¡† */
        }

        /* Claudeå¤é€‰æ¡†å±‚çº§ */
        .claude-output-container .document-checkbox {
            z-index: 35; /* Claudeå¤é€‰æ¡†ï¼Œæœ€é«˜å±‚çº§ */
        }

        .checkbox-input {
            display: none;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .checkbox-label:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        .checkbox-label i {
            font-size: 12px;
            color: transparent;
            transition: color 0.2s ease;
        }

        .checkbox-input:checked + .checkbox-label {
            background: #007bff;
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .checkbox-input:checked + .checkbox-label i {
            color: white;
        }

        /* Excelå·¥å…·æ æ ·å¼ */
        .excel-toolbar {
            background: #f8f9fa; /* ä¸Wordç›¸åŒçš„ç°è‰²èƒŒæ™¯ */
            border-bottom: 1px solid #e5e7eb; /* ä¸Wordç›¸åŒçš„è¾¹æ¡†è‰² */
            padding: 8px 50px 8px 15px; /* ä¸ºå¤é€‰æ¡†ç•™ç©ºé—´ */
            font-size: 11px;
            color: #6b7280; /* ä¸Wordç›¸åŒçš„æ–‡å­—é¢œè‰² */
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: -20px -20px 0 -20px;
        }

        .excel-filename {
            font-weight: 500;
            color: #374151; /* ä¸Wordç›¸åŒçš„æ–‡ä»¶åé¢œè‰² */
        }

        .excel-filename i {
            color: #217346; /* Excelç»¿è‰²å›¾æ ‡ */
            margin-right: 6px;
        }

        .excel-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .excel-content {
            padding: 20px;
            height: calc(100% - 70px); /* åŠ¨æ€é«˜åº¦ï¼Œå‡å»å·¥å…·æ é«˜åº¦ */
            overflow-y: auto;
            background: white;
            margin: 0;
            box-shadow: none;
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        /* éšè—Excelå†…å®¹æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
        .excel-content::-webkit-scrollbar {
            width: 0px;
            background: transparent;
            display: none; /* Chrome, Safari, Opera */
        }

        /* Wordå·¥å…·æ æ ·å¼ */
        .word-toolbar {
            background: #f8f9fa; /* ä¸Excelç›¸åŒçš„ç°è‰²èƒŒæ™¯ */
            border-bottom: 1px solid #e5e7eb; /* ä¸Excelç›¸åŒçš„è¾¹æ¡†è‰² */
            padding: 8px 50px 8px 15px; /* ä¸ºå¤é€‰æ¡†ç•™ç©ºé—´ */
            font-size: 11px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; /* ä¸Excelç›¸åŒçš„ç³»ç»Ÿå­—ä½“ */
            color: #6b7280; /* ä¸Excelç›¸åŒçš„æ–‡å­—é¢œè‰² */
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: -20px -20px 0 -20px;
        }

        .word-filename {
            font-weight: 500;
            color: #374151; /* ä¸Excelç›¸åŒçš„æ–‡ä»¶åé¢œè‰² */
        }

        .word-filename i {
            color: #2b579a; /* Wordè“è‰²å›¾æ ‡ */
            margin-right: 6px;
        }

        .word-toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .word-document {
            padding: 20px;
            height: calc(100% - 70px); /* åŠ¨æ€é«˜åº¦ï¼Œä¸Excelç›¸åŒï¼Œå‡å»å·¥å…·æ é«˜åº¦ */
            overflow-y: auto;
            background: white;
            margin: 0;
            box-shadow: none;
            font-family: 'Calibri', 'Times New Roman', serif; /* Wordæ–‡æ¡£å†…å®¹ä¿æŒCalibriå­—ä½“ */
        }

        /* éšè—Wordæ–‡æ¡£æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
        .word-document::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        .word-document {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .word-header {
            border-bottom: none;
            padding-bottom: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .word-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            font-family: 'Calibri', sans-serif;
        }

        .word-subtitle {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
            font-style: italic;
        }

        .word-content {
            line-height: 1.8;
            color: #1f2937;
            font-size: 14px;
            font-family: 'Calibri', sans-serif;
        }

        .word-section {
            margin-bottom: 25px;
        }

        .word-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            border-left: none;
            padding-left: 0;
            font-family: 'Calibri', sans-serif;
        }

        .word-section p {
            font-size: 14px;
            margin-bottom: 12px;
            text-align: justify;
            text-indent: 0;
            line-height: 1.8;
        }

        .word-list {
            font-size: 14px;
            margin-left: 20px;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .word-list li {
            margin-bottom: 8px;
        }

        .highlight {
            background: #fef3c7;
            padding: 1px 3px;
            border-radius: 2px;
        }

        /* Wordæ–‡æ¡£é¡µè¾¹è·å’Œé¡µé¢æ ·å¼ */
        .word-document::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: #e5e7eb;
        }

        /* åŠ¨ç”»æ•ˆæœ */

        .canvas-area {
            width: 100%;
            height: 100%;
            background: transparent;
            position: relative;
        }

        .canvas-placeholder {
            display: none;
        }

        .canvas-icon {
            width: 80px;
            height: 80px;
            background: #f0f0f0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            font-size: 32px;
        }

        /* Claudeè¾“å‡ºå®¹å™¨æ ·å¼ */
        .claude-output-container {
            position: absolute;
            left: 50%;
            top: 80px;
            width: 48%;
            height: 60vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: none;
            max-height: 60vh;
            overflow: hidden;
            font-family: 'Calibri', 'Times New Roman', serif;
            padding: 10px;
            cursor: move;
            user-select: none;
            display: none; /* é»˜è®¤éšè— */
            z-index: 30; /* Claudeå®¹å™¨å±‚çº§æœ€é«˜ */
        }

        .claude-output-container:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        .claude-output-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 50px 8px 15px;
            font-size: 11px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: -10px -10px 0 -10px;
        }

        .claude-output-filename {
            font-weight: 500;
            color: #374151;
        }

        .claude-output-filename i {
            color: #667eea; /* Claudeç´«è‰²å›¾æ ‡ */
            margin-right: 6px;
        }

        .claude-toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .claude-output-content {
            padding: 5px;
            height: calc(100% - 50px);
            overflow-y: auto;
            background: white;
            margin: 0;
            box-shadow: none;
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .claude-output-content::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        /* æ‚¬æµ®å¯¹è¯æ¡† */
        .chat-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .chat-header {
            background: white;
            color: #333;
            padding: 0;
            display: none;
        }

        .chat-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .chat-messages {
            height: 200px;
            padding: 16px;
            overflow-y: auto;
            background: white;
            transition: height 0.3s ease, opacity 0.3s ease;
        }

        /* å½“æ²¡æœ‰æ¶ˆæ¯æ—¶éšè—å¯¹è¯å†å²åŒºåŸŸ */
        .chat-messages.empty {
            height: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin: 0 10px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #667eea;
            color: white;
        }

        .message.ai .message-avatar {
            background: #e8ecf3;
            color: #667eea;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: 400;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.ai .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .chat-input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e5e5;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 25px;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .chat-input-wrapper:focus-within {
            border-color: #007bff;
            box-shadow: 0 2px 12px rgba(0, 123, 255, 0.15);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0;
            font-size: 15px;
            outline: none;
            resize: none;
            min-height: 22px;
            max-height: 100px;
            line-height: 1.4;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: 400;
        }

        .chat-input::placeholder {
            color: #999;
        }

        .send-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f0f0;
            color: #666;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #bbb;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-container {
                bottom: 20px;
                left: 20px;
                right: 20px;
                width: auto;
                transform: none;
            }
        }

        /* æ¶ˆæ¯åŠ¨ç”»æ•ˆæœ */

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Collab æ¤­åœ†å½¢æ»‘åŠ¨å¼€å…³æ ·å¼ */
        .collab-toggle {
            position: relative;
            width: 42px;
            height: 20px;
            background: #E5E5EA;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
        }

        .collab-toggle:hover {
            background: #D1D1D6;
        }

        .collab-toggle.active {
            background: #34C759;
            justify-content: flex-end;
        }

        .collab-toggle.active:hover {
            background: #30B550;
        }

        .collab-toggle-slider {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #8E8E93;
        }

        .collab-toggle.active .collab-toggle-slider {
            left: calc(100% - 18px);
            background: white;
            color: #34C759;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ç”¨æˆ·åä½œæŒ‡ç¤ºå™¨ */
        .user-collaborator {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            align-items: center;
            gap: 6px;
            background: rgba(0, 122, 204, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 20;
            animation: slideInFromRight 0.3s ease;
        }

        .user-collaborator.active {
            display: flex;
        }

        .user-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
        }

        .user-status {
            font-size: 10px;
            opacity: 0.9;
        }

        /* å•å…ƒæ ¼ç¼–è¾‘åŠ¨ç”» */
        .cell-editing {
            position: relative;
            background: rgba(0, 122, 204, 0.1) !important;
            border: 2px solid #007acc !important;
            animation: cellPulse 1s ease-in-out infinite alternate;
        }

        @keyframes cellPulse {
            from { box-shadow: 0 0 5px rgba(0, 122, 204, 0.3); }
            to { box-shadow: 0 0 15px rgba(0, 122, 204, 0.6); }
        }

        .typing-cursor {
            display: inline-block;
            width: 1px;
            height: 14px;
            background: #007acc;
            animation: blink 1s step-end infinite;
            margin-left: 1px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* æµ®åŠ¨åä½œæ°”æ³¡æ ·å¼ */
        .collaboration-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            white-space: nowrap;
        }
        
        .collaboration-bubble.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        .collaboration-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 12px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(255, 255, 255, 0.95);
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
        }
        
        .bubble-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0078d4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .bubble-name {
            font-weight: 500;
            color: #333;
        }
        
        .bubble-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00c851;
            animation: bubble-pulse 1.5s infinite;
        }
        
        .bubble-status.selecting {
            background: #ffbb33;
            animation: none;
        }
        
        .bubble-status.typing {
            background: #00c851;
            animation: bubble-pulse 1.5s infinite;
        }
        
        .bubble-status.thinking {
            background: #667eea;
            animation: bubble-pulse 1.5s infinite;
        }
        
        @keyframes bubble-pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }
        
        /* æ°”æ³¡æµ®åŠ¨åŠ¨ç”» */
        .collaboration-bubble.floating {
            animation: bubble-float 3s ease-in-out infinite;
        }
        
        @keyframes bubble-float {
            0%, 100% {
                transform: scale(1) translateY(0px);
            }
            50% {
                transform: scale(1) translateY(-2px);
            }
        }

        /* Wordåä½œæ°”æ³¡ç‰¹å®šæ ·å¼ */
        .word-collaboration-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            white-space: nowrap;
        }
        
        .word-collaboration-bubble.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        .word-collaboration-bubble::after {
            content: '';
            position: absolute;
            left: 20px; /* ç®­å¤´è·ç¦»æ°”æ³¡å·¦è¾¹ç¼˜20px */
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
        }
        
        /* é»˜è®¤ç®­å¤´æŒ‡å‘ä¸‹æ–¹ï¼ˆæ°”æ³¡åœ¨å…ƒç´ ä¸Šæ–¹æ—¶ï¼‰ */
        .word-collaboration-bubble::after {
            bottom: -6px;
            border-top: 6px solid rgba(255, 255, 255, 0.95);
        }
        
        /* å½“æ°”æ³¡åœ¨å…ƒç´ ä¸‹æ–¹æ—¶ï¼Œç®­å¤´æŒ‡å‘ä¸Šæ–¹ */
        .word-collaboration-bubble[style*="--arrow-direction: up"]::after {
            top: -6px;
            bottom: auto;
            border-top: none;
            border-bottom: 6px solid rgba(255, 255, 255, 0.95);
        }
        
        .word-collaboration-bubble .bubble-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #28a745; /* Yuecongä½¿ç”¨ç»¿è‰²å¤´åƒ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .word-collaboration-bubble.floating {
            animation: bubble-float 3s ease-in-out infinite;
        }

        /* Claudeåä½œæ°”æ³¡ç‰¹å®šæ ·å¼ */
        .claude-collaboration-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            white-space: nowrap;
            max-width: 200px;
        }
        
        .claude-collaboration-bubble.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        .claude-collaboration-bubble::after {
            content: '';
            position: absolute;
            right: 20px; /* ç®­å¤´è·ç¦»æ°”æ³¡å³è¾¹ç¼˜20px */
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
        }
        
        /* é»˜è®¤ç®­å¤´æŒ‡å‘ä¸‹æ–¹ï¼ˆæ°”æ³¡åœ¨ä¸Šæ–¹æ—¶ï¼‰ */
        .claude-collaboration-bubble::after {
            bottom: -6px;
            border-top: 6px solid rgba(255, 255, 255, 0.95);
        }
        
        /* å½“æ°”æ³¡åœ¨ä¸‹æ–¹æ—¶ï¼Œç®­å¤´æŒ‡å‘ä¸Šæ–¹ */
        .claude-collaboration-bubble[style*="--arrow-direction: up"]::after {
            top: -6px;
            bottom: auto;
            border-top: none;
            border-bottom: 6px solid rgba(255, 255, 255, 0.95);
        }
        
        .claude-collaboration-bubble .bubble-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea; /* Claudeç´«è‰²å¤´åƒ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .claude-collaboration-bubble.floating {
            animation: bubble-float 3s ease-in-out infinite;
        }

        /* Wordæ–‡æ¡£å…‰æ ‡åŠ¨ç”» */
        .typing-cursor {
            display: inline-block;
            width: 1px;
            height: 16px;
            background-color: #333;
            margin-left: 1px;
        }

        @keyframes cursor-blink {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0;
            }
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* å…¨å±€åŠ¨ç”»æ§åˆ¶å¼€å…³ */
        .global-animation-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            transition: all 0.3s ease;
        }
        
        .global-animation-control:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .global-animation-toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .global-animation-toggle.active {
            background: #10b981;
        }
        
        .global-animation-toggle .slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .global-animation-toggle.active .slider {
            transform: translateX(24px);
        }
        
        .global-animation-control .icon {
            font-size: 16px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CanvasåŒºåŸŸ -->
        <div class="canvas-container">
            <div class="canvas-area">
                <div class="canvas-placeholder">
                    <div class="canvas-icon">ğŸ¨</div>
                    <p>æ‚¨çš„åˆ›ä½œç”»å¸ƒ</p>
                    <p style="font-size: 14px; margin-top: 8px; opacity: 0.7;">å¼€å§‹ä¸AIå¯¹è¯æ¥åˆ›å»ºè®¾è®¡</p>
                </div>
            </div>

            <!-- Excelè¡¨æ ¼ -->
            <div class="excel-container">
                <div class="document-checkbox" data-document="excel">
                    <input type="checkbox" id="excel-checkbox" class="checkbox-input">
                    <label for="excel-checkbox" class="checkbox-label">
                        <i class="fas fa-check"></i>
                    </label>
                </div>
                <!-- è°ƒæ•´å¤§å°æ‰‹æŸ„ -->
                <div class="resize-handle resize-handle-se"></div>
                <div class="resize-handle resize-handle-e"></div>
                <div class="resize-handle resize-handle-s"></div>
                <div class="excel-toolbar">
                    <div class="excel-filename"><i class="fas fa-file-excel"></i> PPT_Template_Search_Data.xlsx</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="collab-toggle" id="collab-toggle">
                            <div class="collab-toggle-slider">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div>Microsoft Excel</div>
                    </div>
                </div>
                <div class="excel-content">
                    <div class="excel-title">PPT Template Search Data</div>
                    <table class="excel-table">
                    <thead>
                        <tr>
                            <th>Search Query</th>
                            <th>Frequency</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="search-query">business presentation template</td>
                            <td class="search-frequency">2,847</td>
                        </tr>
                        <tr>
                            <td class="search-query">corporate slides design</td>
                            <td class="search-frequency">2,156</td>
                        </tr>
                        <tr>
                            <td class="search-query">marketing pitch deck</td>
                            <td class="search-frequency">1,923</td>
                        </tr>
                        <tr>
                            <td class="search-query">modern powerpoint template</td>
                            <td class="search-frequency">1,784</td>
                        </tr>
                        <tr>
                            <td class="search-query">startup pitch presentation</td>
                            <td class="search-frequency">1,567</td>
                        </tr>
                        <tr>
                            <td class="search-query">financial report template</td>
                            <td class="search-frequency">1,432</td>
                        </tr>
                        <tr>
                            <td class="search-query">project proposal slides</td>
                            <td class="search-frequency">1,298</td>
                        </tr>
                        <tr>
                            <td class="search-query">creative presentation design</td>
                            <td class="search-frequency">1,189</td>
                        </tr>
                        <tr>
                            <td class="search-query">annual report template</td>
                            <td class="search-frequency">1,067</td>
                        </tr>
                        <tr>
                            <td class="search-query">sales presentation template</td>
                            <td class="search-frequency">945</td>
                        </tr>
                        <tr>
                            <td class="search-query">educational slides template</td>
                            <td class="search-frequency">876</td>
                        </tr>
                        <tr>
                            <td class="search-query">conference presentation</td>
                            <td class="search-frequency">798</td>
                        </tr>
                        <tr>
                            <td class="search-query">timeline presentation template</td>
                            <td class="search-frequency">723</td>
                        </tr>
                        <tr>
                            <td class="search-query">data visualization slides</td>
                            <td class="search-frequency">654</td>
                        </tr>
                        <tr>
                            <td class="search-query">team presentation template</td>
                            <td class="search-frequency">587</td>
                        </tr>
                        <tr>
                            <td class="search-query">product launch presentation</td>
                            <td class="search-frequency">512</td>
                        </tr>
                        <tr>
                            <td class="search-query">strategy presentation template</td>
                            <td class="search-frequency">445</td>
                        </tr>
                        <tr>
                            <td class="search-query">training presentation slides</td>
                            <td class="search-frequency">378</td>
                        </tr>
                        <tr>
                            <td class="search-query">investor pitch template</td>
                            <td class="search-frequency">321</td>
                        </tr>
                        <tr>
                            <td class="search-query">minimal presentation design</td>
                            <td class="search-frequency">267</td>
                        </tr>
                    </tbody>
                </table>
                </div>
            </div>

            <!-- Wordæ–‡æ¡£ -->
            <div class="word-container">
                <div class="document-checkbox" data-document="word">
                    <input type="checkbox" id="word-checkbox" class="checkbox-input">
                    <label for="word-checkbox" class="checkbox-label">
                        <i class="fas fa-check"></i>
                    </label>
                </div>
                <!-- è°ƒæ•´å¤§å°æ‰‹æŸ„ -->
                <div class="resize-handle resize-handle-se"></div>
                <div class="resize-handle resize-handle-e"></div>
                <div class="resize-handle resize-handle-s"></div>
                <div class="word-toolbar">
                    <div class="word-filename"><i class="fas fa-file-word"></i> Research_Report.docx</div>
                    <div class="word-toolbar-right">
                        <div class="collab-toggle" id="word-collab-toggle">
                            <div class="collab-toggle-slider">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <span>Microsoft Word</span>
                    </div>
                </div>
                
                <div class="word-document">
                    <div class="word-header">
                        <div class="word-title">PPT Template User Research Report</div>
                        <div class="word-subtitle">Market Analysis & User Behavior Study | December 2024</div>
                    </div>

                    <div class="word-content">
                        <div class="word-section">
                            <h3>Executive Summary</h3>
                            <p>This comprehensive user research report analyzes the current market trends and user preferences for PowerPoint templates. Based on extensive data collection from over <span class="highlight">50,000 users</span> across different industries, we identify key patterns in template usage and design preferences.</p>
                        </div>

                        <div class="word-section">
                            <h3>Key Findings</h3>
                            <ul class="word-list">
                                <li><strong>Business Templates:</strong> Account for 68% of all searches</li>
                                <li><strong>Visual Design:</strong> Modern, clean layouts preferred by 84% of users</li>
                                <li><strong>Color Schemes:</strong> Professional blue/grey combinations dominate</li>
                                <li><strong>Industry Focus:</strong> Corporate and startup presentations lead demand</li>
                            </ul>
                        </div>

                        <div class="word-section">
                            <h3>User Demographics</h3>
                            <p>Primary users consist of business professionals (45%), educators (23%), consultants (18%), and entrepreneurs (14%). The majority of users are aged between 25-45 years and work in corporate environments requiring regular presentation creation.</p>
                        </div>

                        <div class="word-section">
                            <h3>Design Preferences</h3>
                            <p>Users consistently favor templates with <span class="highlight">minimalist designs</span>, clear typography, and structured layouts. Data visualization capabilities and infographic elements are increasingly important, with 72% of users seeking templates that support chart integration.</p>
                        </div>

                        <div class="word-section">
                            <h3>Market Opportunities</h3>
                            <ul class="word-list">
                                <li>Industry-specific template collections</li>
                                <li>Interactive presentation elements</li>
                                <li>AI-powered design suggestions</li>
                                <li>Collaborative editing features</li>
                            </ul>
                        </div>

                        <div class="word-section">
                            <h3>Recommendations</h3>
                            <p>Based on our research, we recommend focusing on creating versatile business templates with customizable color schemes and enhanced data visualization tools. Priority should be given to developing templates for emerging sectors like technology startups and sustainable business presentations.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Claudeä»»åŠ¡è¾“å‡ºå®¹å™¨ -->
            <div class="claude-output-container" id="claudeOutputContainer">
                <div class="document-checkbox" data-document="claude">
                    <input type="checkbox" id="claude-checkbox" class="checkbox-input">
                    <label for="claude-checkbox" class="checkbox-label">
                        <i class="fas fa-check"></i>
                    </label>
                </div>
                <!-- è°ƒæ•´å¤§å°æ‰‹æŸ„ -->
                <div class="resize-handle resize-handle-se"></div>
                <div class="resize-handle resize-handle-e"></div>
                <div class="resize-handle resize-handle-s"></div>
                <div class="claude-output-toolbar">
                    <div class="claude-output-filename">
                        <i class="fas fa-robot"></i> 
                        <span id="claudeTaskTitle">Claude Task Output</span>
                    </div>
                    <div class="claude-toolbar-right">
                        <span>Claude Sonnet 4</span>
                    </div>
                </div>
                
                <div class="claude-output-content" id="claudeOutputContent">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-robot" style="font-size: 32px; margin-bottom: 15px; color: #667eea;"></i>
                        <p>Claude will display task results here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‚¬æµ®å¯¹è¯æ¡† -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Ask Clippy Anything"
                        rows="1"></textarea>
                    <button class="send-button" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŸºç¡€JavaScriptåŠŸèƒ½
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        
        // å­˜å‚¨å¯¹è¯å†å²
        let conversationHistory = [];
        // ç¯å¢ƒè‡ªé€‚åº”çš„APIåŸºç¡€URL
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000' 
            : window.location.origin;

        // ===== Excelåä½œåŠ¨ç”»ç³»ç»Ÿ =====
        class ExcelCollaborationAnimator {
            constructor() {
                this.isActive = false;
                this.animationInterval = null;
                this.currentStep = 0;
                this.collaborationBubble = null;
                
                // æ·»åŠ çŠ¶æ€ç®¡ç†
                this.activeTimeouts = new Set();
                this.animatingCells = new Set();
                this.isAnimationRunning = false;
                
                // åŠ¨ç”»åºåˆ—é…ç½®
                this.animationSequence = [
                    { action: 'selectCell', target: 'tbody tr:nth-child(2) td:nth-child(1)', duration: 1000, text: '' },
                    { action: 'typeText', target: 'tbody tr:nth-child(2) td:nth-child(1)', duration: 2000, text: 'AI assistant template' },
                    { action: 'pause', duration: 800 },
                    { action: 'selectCell', target: 'tbody tr:nth-child(2) td:nth-child(2)', duration: 1000, text: '' },
                    { action: 'editNumber', target: 'tbody tr:nth-child(2) td:nth-child(2)', duration: 1500, newValue: '3156' },
                    { action: 'pause', duration: 1200 },
                    { action: 'selectCell', target: 'tbody tr:nth-child(3) td:nth-child(1)', duration: 1000, text: '' },
                    { action: 'typeText', target: 'tbody tr:nth-child(3) td:nth-child(1)', duration: 2000, text: 'modern AI dashboard' },
                    { action: 'pause', duration: 800 },
                    { action: 'selectCell', target: 'tbody tr:nth-child(3) td:nth-child(2)', duration: 1000, text: '' },
                    { action: 'editNumber', target: 'tbody tr:nth-child(3) td:nth-child(2)', duration: 1500, newValue: '2389' }
                ];
                
                this.init();
            }
            
            init() {
                const toggleBtn = document.getElementById('collab-toggle');
                const excelContainer = document.querySelector('.excel-container');
                
                // åˆ›å»ºæµ®åŠ¨æ°”æ³¡
                this.createCollaborationBubble();
                
                // åˆ‡æ¢æŒ‰é’®äº‹ä»¶
                toggleBtn.addEventListener('click', () => {
                    this.toggle();
                });
            }
            
            createCollaborationBubble() {
                const excelContainer = document.querySelector('.excel-container');
                
                this.collaborationBubble = document.createElement('div');
                this.collaborationBubble.className = 'collaboration-bubble';
                this.collaborationBubble.innerHTML = `
                    <div class="bubble-avatar">A</div>
                    <span class="bubble-name">Aibo</span>
                    <div class="bubble-status selecting"></div>
                `;
                
                excelContainer.appendChild(this.collaborationBubble);
            }
            
            toggle() {
                const toggleBtn = document.getElementById('collab-toggle');
                
                this.isActive = !this.isActive;
                
                if (this.isActive) {
                    toggleBtn.classList.add('active');
                    this.startAnimation();
                } else {
                    toggleBtn.classList.remove('active');
                    this.stopAnimation();
                    this.hideBubble();
                }
            }
            
            startAnimation() {
                if (this.animationInterval) return;
                
                this.currentStep = 0;
                this.runAnimationSequence();
            }
            
            stopAnimation() {
                if (this.animationInterval) {
                    clearTimeout(this.animationInterval);
                    this.animationInterval = null;
                }
                
                // æ¸…ç†æ‰€æœ‰æ´»åŠ¨çš„setTimeout
                this.activeTimeouts.forEach(timeoutId => {
                    clearTimeout(timeoutId);
                });
                this.activeTimeouts.clear();
                
                // é‡ç½®çŠ¶æ€
                this.isAnimationRunning = false;
                this.animatingCells.clear();
                
                // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰åŠ¨ç”»æ•ˆæœ
                this.clearAllAnimations();
            }
            
            runAnimationSequence() {
                if (!this.isActive || this.isAnimationRunning) return;
                
                // è®¾ç½®è¿è¡ŒçŠ¶æ€æ ‡å¿—
                this.isAnimationRunning = true;
                
                const step = this.animationSequence[this.currentStep];
                if (!step) {
                    // é‡ç½®åˆ°å¼€å§‹
                    this.currentStep = 0;
                    this.isAnimationRunning = false;
                    this.animationInterval = setTimeout(() => this.runAnimationSequence(), 3000);
                    return;
                }
                
                this.executeStep(step).then(() => {
                    this.currentStep++;
                    this.isAnimationRunning = false;
                    this.animationInterval = setTimeout(() => this.runAnimationSequence(), step.duration);
                }).catch(() => {
                    // å‡ºé”™æ—¶é‡ç½®çŠ¶æ€
                    this.isAnimationRunning = false;
                    this.currentStep = 0;
                });
            }
            
            async executeStep(step) {
                const excelTable = document.querySelector('.excel-table');
                if (!excelTable) return;
                
                switch (step.action) {
                    case 'selectCell':
                        this.selectCell(excelTable.querySelector(step.target));
                        break;
                    case 'typeText':
                        await this.typeInCell(excelTable.querySelector(step.target), step.text);
                        break;
                    case 'editNumber':
                        await this.editNumberInCell(excelTable.querySelector(step.target), step.newValue);
                        break;
                    case 'pause':
                        // ä»€ä¹ˆä¹Ÿä¸åšï¼Œåªæ˜¯ç­‰å¾…
                        break;
                }
            }
            
            selectCell(cell) {
                if (!cell) return;
                
                // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.cell-editing').forEach(c => {
                    c.classList.remove('cell-editing');
                });
                
                // é€‰ä¸­æ–°å•å…ƒæ ¼
                cell.classList.add('cell-editing');
                
                // æ˜¾ç¤ºå¹¶å®šä½æ°”æ³¡
                this.showBubbleAtCell(cell, 'selecting');
            }
            
            showBubbleAtCell(targetCell, status = 'selecting') {
                if (!targetCell || !this.collaborationBubble) return;
                
                const excelContainer = document.querySelector('.excel-container');
                const cellRect = targetCell.getBoundingClientRect();
                const containerRect = excelContainer.getBoundingClientRect();
                
                // è®¡ç®—ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
                let x = cellRect.left - containerRect.left + cellRect.width + 10;
                let y = cellRect.top - containerRect.top - 10;
                
                // è¾¹ç•Œæ£€æµ‹å’Œè°ƒæ•´
                const bubbleWidth = 90; // ä¼°ç®—æ°”æ³¡å®½åº¦
                const bubbleHeight = 32; // ä¼°ç®—æ°”æ³¡é«˜åº¦
                
                if (x + bubbleWidth > excelContainer.clientWidth) {
                    x = cellRect.left - containerRect.left - bubbleWidth - 10; // ç§»åˆ°å·¦ä¾§
                }
                if (y < 0) {
                    y = cellRect.bottom - containerRect.top + 5; // ç§»åˆ°ä¸‹æ–¹
                    // è°ƒæ•´ç®­å¤´æŒ‡å‘
                    this.collaborationBubble.style.setProperty('--arrow-direction', 'up');
                } else {
                    this.collaborationBubble.style.setProperty('--arrow-direction', 'down');
                }
                
                // è®¾ç½®ä½ç½®
                this.collaborationBubble.style.left = x + 'px';
                this.collaborationBubble.style.top = y + 'px';
                
                // æ›´æ–°çŠ¶æ€
                this.updateBubbleStatus(status);
                
                // æ˜¾ç¤ºæ°”æ³¡
                this.collaborationBubble.classList.add('active');
                this.collaborationBubble.classList.add('floating');
            }
            
            updateBubbleStatus(status) {
                const statusDot = this.collaborationBubble.querySelector('.bubble-status');
                statusDot.className = `bubble-status ${status}`;
            }
            
            hideBubble() {
                if (this.collaborationBubble) {
                    this.collaborationBubble.classList.remove('active');
                    this.collaborationBubble.classList.remove('floating');
                }
            }
            
            async typeInCell(cell, text) {
                if (!cell || !text) return;
                
                // æ£€æŸ¥å¹¶é˜²æ­¢é‡å¤åŠ¨ç”»
                const cellKey = cell.cellIndex + '_' + cell.parentNode.rowIndex;
                if (this.animatingCells.has(cellKey)) {
                    console.warn('Cell is already animating, skipping...');
                    return;
                }
                
                // å¼ºåˆ¶æ¸…ç†è¯¥å•å…ƒæ ¼çš„æ‰€æœ‰æ®‹ç•™
                this.forceClearCell(cell);
                
                // æ¸…ç©ºå•å…ƒæ ¼å†…å®¹ - è¿™è¡Œå¾ˆé‡è¦ï¼
                cell.innerHTML = '';
                
                // æ ‡è®°å•å…ƒæ ¼ä¸ºåŠ¨ç”»ä¸­
                this.animatingCells.add(cellKey);
                
                // æ›´æ–°æ°”æ³¡çŠ¶æ€ä¸ºè¾“å…¥ä¸­
                this.updateBubbleStatus('typing');
                
                return new Promise((resolve) => {
                    let i = 0;
                    const cursor = document.createElement('span');
                    cursor.className = 'typing-cursor';
                    
                    const typeChar = () => {
                        // æ£€æŸ¥åŠ¨ç”»æ˜¯å¦åº”è¯¥ç»§ç»­
                        if (!this.isActive || !this.animatingCells.has(cellKey)) {
                            cursor.remove();
                            this.animatingCells.delete(cellKey);
                            resolve();
                            return;
                        }
                        
                        if (i < text.length) {
                            cell.textContent += text.charAt(i);
                            // ç§»é™¤æ—§å…‰æ ‡å†æ·»åŠ æ–°å…‰æ ‡
                            const oldCursors = cell.querySelectorAll('.typing-cursor');
                            oldCursors.forEach(c => c.remove());
                            cell.appendChild(cursor);
                            i++;
                            
                            // è®°å½•setTimeout ID
                            const timeoutId = setTimeout(typeChar, 100);
                            this.activeTimeouts.add(timeoutId);
                        } else {
                            cursor.remove();
                            this.animatingCells.delete(cellKey);
                            this.updateBubbleStatus('selecting');
                            resolve();
                        }
                    };
                    
                    cell.appendChild(cursor);
                    const initialTimeoutId = setTimeout(typeChar, 200);
                    this.activeTimeouts.add(initialTimeoutId);
                });
            }
            
            async editNumberInCell(cell, newValue) {
                if (!cell || !newValue) return;
                
                // æ£€æŸ¥å¹¶é˜²æ­¢é‡å¤åŠ¨ç”»
                const cellKey = cell.cellIndex + '_' + cell.parentNode.rowIndex;
                if (this.animatingCells.has(cellKey)) {
                    console.warn('Cell is already animating, skipping...');
                    return;
                }
                
                // å¼ºåˆ¶æ¸…ç†è¯¥å•å…ƒæ ¼çš„æ‰€æœ‰æ®‹ç•™
                this.forceClearCell(cell);
                
                // æ ‡è®°å•å…ƒæ ¼ä¸ºåŠ¨ç”»ä¸­
                this.animatingCells.add(cellKey);
                
                return new Promise((resolve) => {
                    // å°†æ•°å­—è½¬æ¢ä¸ºåƒåˆ†ä½æ ¼å¼
                    const formattedValue = parseInt(newValue).toLocaleString();
                    
                    // æ›´æ–°æ°”æ³¡çŠ¶æ€ä¸ºé€‰æ‹©ä¸­
                    this.updateBubbleStatus('selecting');
                    
                    // ç¬¬ä¸€é˜¶æ®µï¼šå…¨é€‰æ•ˆæœï¼ˆæ¨¡æ‹ŸCtrl+Aï¼‰
                    cell.style.backgroundColor = '#0078d4';
                    cell.style.color = 'white';
                    
                    const selectTimeoutId = setTimeout(() => {
                        // æ£€æŸ¥åŠ¨ç”»æ˜¯å¦åº”è¯¥ç»§ç»­
                        if (!this.isActive || !this.animatingCells.has(cellKey)) {
                            this.resetCellStyle(cell);
                            this.animatingCells.delete(cellKey);
                            resolve();
                            return;
                        }
                        
                        // ç¬¬äºŒé˜¶æ®µï¼šåˆ é™¤å†…å®¹ï¼ˆæ¨¡æ‹ŸDeleteé”®ï¼‰
                        cell.textContent = '';
                        this.resetCellStyle(cell);
                        
                        // æ›´æ–°æ°”æ³¡çŠ¶æ€ä¸ºè¾“å…¥ä¸­
                        this.updateBubbleStatus('typing');
                        
                        // ç¬¬ä¸‰é˜¶æ®µï¼šé€ä½è¾“å…¥æ–°æ•°å­—ï¼ˆåŒ…æ‹¬é€—å·ï¼‰
                        let i = 0;
                        const cursor = document.createElement('span');
                        cursor.className = 'typing-cursor';
                        
                        const typeDigit = () => {
                            // æ£€æŸ¥åŠ¨ç”»æ˜¯å¦åº”è¯¥ç»§ç»­
                            if (!this.isActive || !this.animatingCells.has(cellKey)) {
                                cursor.remove();
                                this.animatingCells.delete(cellKey);
                                resolve();
                                return;
                            }
                            
                            if (i < formattedValue.length) {
                                cell.textContent += formattedValue.charAt(i);
                                // ç§»é™¤æ—§å…‰æ ‡å†æ·»åŠ æ–°å…‰æ ‡
                                const oldCursors = cell.querySelectorAll('.typing-cursor');
                                oldCursors.forEach(c => c.remove());
                                cell.appendChild(cursor);
                                i++;
                                
                                const digitTimeoutId = setTimeout(typeDigit, 150);
                                this.activeTimeouts.add(digitTimeoutId);
                            } else {
                                cursor.remove();
                                this.animatingCells.delete(cellKey);
                                this.updateBubbleStatus('selecting');
                                resolve();
                            }
                        };
                        
                        cell.appendChild(cursor);
                        const initialDigitTimeoutId = setTimeout(typeDigit, 300);
                        this.activeTimeouts.add(initialDigitTimeoutId);
                        
                    }, 500);
                    
                    this.activeTimeouts.add(selectTimeoutId);
                });
            }
            
            clearAllAnimations() {
                // æ¸…é™¤æ‰€æœ‰åŠ¨ç”»æ•ˆæœ
                document.querySelectorAll('.cell-editing').forEach(cell => {
                    cell.classList.remove('cell-editing');
                    this.resetCellStyle(cell);
                });
                
                // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰å•å…ƒæ ¼
                document.querySelectorAll('td').forEach(cell => {
                    this.forceClearCell(cell);
                });
                
                // é‡ç½®çŠ¶æ€
                this.animatingCells.clear();
            }
            
            forceClearCell(cell) {
                // ç§»é™¤æ‰€æœ‰å…‰æ ‡å…ƒç´ 
                const cursors = cell.querySelectorAll('.typing-cursor');
                cursors.forEach(cursor => cursor.remove());
                
                // é‡ç½®æ ·å¼
                this.resetCellStyle(cell);
            }
            
            resetCellStyle(cell) {
                cell.style.backgroundColor = '';
                cell.style.color = '';
            }
        }
        
        // ===== Wordåä½œåŠ¨ç”»ç³»ç»Ÿ =====
        class WordCollaborationAnimator {
            constructor() {
                this.isActive = false;
                this.animationInterval = null;
                this.currentStep = 0;
                this.collaborationBubble = null;
                
                // çŠ¶æ€ç®¡ç†
                this.activeTimeouts = new Set();
                this.isAnimationRunning = false;
                this.currentBulletIndex = 0;
                
                // è¦æ’å…¥çš„bullet pointå†…å®¹
                this.bulletPoints = [
                    'Interactive Elements: Users increasingly prefer templates with interactive features like clickable charts and embedded forms',
                    'Mobile Optimization: 76% of users access presentations on mobile devices, requiring responsive template designs',
                    'Brand Consistency: Companies seek templates that can easily incorporate their brand colors and logos while maintaining professional aesthetics'
                ];
                
                this.init();
            }
            
            init() {
                const toggleBtn = document.getElementById('word-collab-toggle');
                const wordContainer = document.querySelector('.word-container');
                
                // åˆ›å»ºåä½œæ°”æ³¡
                this.createCollaborationBubble();
                
                // åˆ‡æ¢æŒ‰é’®äº‹ä»¶
                toggleBtn.addEventListener('click', () => {
                    this.toggle();
                });
            }
            
            createCollaborationBubble() {
                const wordContainer = document.querySelector('.word-container');
                
                this.collaborationBubble = document.createElement('div');
                this.collaborationBubble.className = 'word-collaboration-bubble';
                this.collaborationBubble.innerHTML = `
                    <div class="bubble-avatar">Y</div>
                    <span class="bubble-name">Yuecong</span>
                    <div class="bubble-status selecting"></div>
                `;
                
                wordContainer.appendChild(this.collaborationBubble);
            }
            
            toggle() {
                const toggleBtn = document.getElementById('word-collab-toggle');
                
                this.isActive = !this.isActive;
                
                if (this.isActive) {
                    toggleBtn.classList.add('active');
                    this.startAnimation();
                } else {
                    toggleBtn.classList.remove('active');
                    this.stopAnimation();
                    this.hideBubble();
                }
            }
            
            startAnimation() {
                if (this.animationInterval) return;
                
                this.currentBulletIndex = 0;
                this.runAnimationSequence();
            }
            
            stopAnimation() {
                if (this.animationInterval) {
                    clearTimeout(this.animationInterval);
                    this.animationInterval = null;
                }
                
                // æ¸…ç†æ‰€æœ‰æ´»åŠ¨çš„timeout
                this.activeTimeouts.forEach(timeoutId => {
                    clearTimeout(timeoutId);
                });
                this.activeTimeouts.clear();
                
                // é‡ç½®çŠ¶æ€
                this.isAnimationRunning = false;
                
                // æ¸…ç†åŠ¨ç”»æ•ˆæœ
                this.clearAllAnimations();
            }
            
            runAnimationSequence() {
                if (!this.isActive || this.isAnimationRunning) return;
                
                this.isAnimationRunning = true;
                
                if (this.currentBulletIndex >= this.bulletPoints.length) {
                    // å¾ªç¯é‡ç½®ï¼šæ¸…ç©ºä¹‹å‰æ·»åŠ çš„bullet points
                    this.clearAddedBulletPoints();
                    this.currentBulletIndex = 0;
                    this.isAnimationRunning = false;
                    // æ¸…ç©ºåç¨ç­‰ä¸€ä¸‹å†å¼€å§‹ä¸‹ä¸€è½®
                    this.animationInterval = setTimeout(() => this.runAnimationSequence(), 3000);
                    return;
                }
                
                this.insertBulletPoint(this.currentBulletIndex).then(() => {
                    this.currentBulletIndex++;
                    this.isAnimationRunning = false;
                    // çŸ­æš‚åœé¡¿åç»§ç»­ä¸‹ä¸€ä¸ªbullet point
                    this.animationInterval = setTimeout(() => this.runAnimationSequence(), 2000);
                }).catch(() => {
                    this.isAnimationRunning = false;
                    this.currentBulletIndex = 0;
                });
            }
            
            async insertBulletPoint(index) {
                const keyFindingsList = document.querySelector('.word-list');
                if (!keyFindingsList) return;
                
                const bulletText = this.bulletPoints[index];
                
                // åˆ›å»ºæ–°çš„liå…ƒç´ å¹¶æ·»åŠ æ ‡è®°
                const newBullet = document.createElement('li');
                newBullet.classList.add('yuecong-added-bullet'); // æ·»åŠ æ ‡è®°ç±»
                
                // æ’å…¥åˆ°ç¬¬ä¸€ä¸ªliä¹‹å
                const firstBullet = keyFindingsList.querySelector('li');
                if (firstBullet && firstBullet.nextSibling) {
                    keyFindingsList.insertBefore(newBullet, firstBullet.nextSibling);
                } else {
                    keyFindingsList.appendChild(newBullet);
                }
                
                // æ˜¾ç¤ºæ°”æ³¡å¹¶å®šä½åˆ°æ–°bullet point
                this.showBubbleAtElement(newBullet, 'typing');
                
                // é€å­—è¾“å…¥æ–‡æœ¬
                await this.typeInElement(newBullet, bulletText);
                
                // è¾“å…¥å®Œæˆåæ›´æ–°çŠ¶æ€
                this.updateBubbleStatus('selecting');
                
                // çŸ­æš‚åœé¡¿
                await this.delay(800);
            }
            
            async typeInElement(element, text) {
                return new Promise((resolve) => {
                    let i = 0;
                    const cursor = document.createElement('span');
                    cursor.className = 'typing-cursor';
                    cursor.style.animation = 'cursor-blink 1s infinite';
                    
                    const typeChar = () => {
                        if (!this.isActive) {
                            cursor.remove();
                            resolve();
                            return;
                        }
                        
                        if (i < text.length) {
                            // ç§»é™¤å…‰æ ‡ï¼Œæ·»åŠ å­—ç¬¦ï¼Œé‡æ–°æ·»åŠ å…‰æ ‡
                            cursor.remove();
                            element.textContent += text.charAt(i);
                            element.appendChild(cursor);
                            i++;
                            
                            const timeoutId = setTimeout(typeChar, 50); // å¿«é€Ÿè¾“å…¥
                            this.activeTimeouts.add(timeoutId);
                        } else {
                            cursor.remove();
                            resolve();
                        }
                    };
                    
                    // æ·»åŠ å…‰æ ‡å¼€å§‹è¾“å…¥
                    element.appendChild(cursor);
                    const initialTimeoutId = setTimeout(typeChar, 200);
                    this.activeTimeouts.add(initialTimeoutId);
                });
            }
            
            showBubbleAtElement(targetElement, status = 'selecting') {
                if (!targetElement || !this.collaborationBubble) return;
                
                const wordContainer = document.querySelector('.word-container');
                const elementRect = targetElement.getBoundingClientRect();
                const containerRect = wordContainer.getBoundingClientRect();
                
                // å°†æ°”æ³¡æ”¾åœ¨å…ƒç´ ä¸Šæ–¹ï¼Œæ°´å¹³å±…å·¦å¯¹é½
                const bubbleWidth = 100;
                const bubbleHeight = 32;
                
                // è®¡ç®—æ°´å¹³ä½ç½®ï¼ˆå·¦å¯¹é½åˆ°bullet pointçš„å·¦è¾¹ç¼˜ï¼‰
                let x = elementRect.left - containerRect.left;
                
                // è®¡ç®—å‚ç›´ä½ç½®ï¼ˆåœ¨å…ƒç´ ä¸Šæ–¹ï¼‰
                let y = elementRect.top - containerRect.top - bubbleHeight - 10;
                
                // è¾¹ç•Œæ£€æµ‹å’Œè°ƒæ•´
                // ç¡®ä¿æ°”æ³¡ä¸è¶…å‡ºå®¹å™¨å·¦è¾¹ç•Œ
                if (x < 10) {
                    x = 10;
                }
                // ç¡®ä¿æ°”æ³¡ä¸è¶…å‡ºå®¹å™¨å³è¾¹ç•Œ
                if (x + bubbleWidth > wordContainer.clientWidth - 10) {
                    x = wordContainer.clientWidth - bubbleWidth - 10;
                }
                
                // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ”¾åˆ°ä¸‹æ–¹
                if (y < 10) {
                    y = elementRect.bottom - containerRect.top + 10;
                    // è°ƒæ•´ç®­å¤´æŒ‡å‘ï¼ˆä¸Šæ–¹ï¼‰
                    this.collaborationBubble.style.setProperty('--arrow-direction', 'up');
                } else {
                    // è®¾ç½®ç®­å¤´æŒ‡å‘ï¼ˆä¸‹æ–¹ï¼‰
                    this.collaborationBubble.style.setProperty('--arrow-direction', 'down');
                }
                
                // è®¾ç½®ä½ç½®
                this.collaborationBubble.style.left = x + 'px';
                this.collaborationBubble.style.top = y + 'px';
                
                // æ›´æ–°çŠ¶æ€
                this.updateBubbleStatus(status);
                
                // æ˜¾ç¤ºæ°”æ³¡
                this.collaborationBubble.classList.add('active');
                this.collaborationBubble.classList.add('floating');
            }
            
            updateBubbleStatus(status) {
                const statusDot = this.collaborationBubble.querySelector('.bubble-status');
                statusDot.className = `bubble-status ${status}`;
            }
            
            hideBubble() {
                if (this.collaborationBubble) {
                    this.collaborationBubble.classList.remove('active');
                    this.collaborationBubble.classList.remove('floating');
                }
            }
            
            clearAddedBulletPoints() {
                // ç§»é™¤æ‰€æœ‰Yuecongæ·»åŠ çš„bullet points
                const addedBullets = document.querySelectorAll('.yuecong-added-bullet');
                addedBullets.forEach(bullet => {
                    bullet.remove();
                });
            }
            
            clearAllAnimations() {
                // ç§»é™¤æ‰€æœ‰å…‰æ ‡
                document.querySelectorAll('.typing-cursor').forEach(cursor => {
                    cursor.remove();
                });
                
                // åŒæ—¶æ¸…ç©ºæ·»åŠ çš„bullet pointsï¼ˆåœæ­¢åŠ¨ç”»æ—¶ï¼‰
                this.clearAddedBulletPoints();
            }
            
            delay(ms) {
                return new Promise(resolve => {
                    const timeoutId = setTimeout(resolve, ms);
                    this.activeTimeouts.add(timeoutId);
                });
            }
        }
        
        // ===== Claude AIåä½œåŠ¨ç”»ç³»ç»Ÿ =====
        class ClaudeAIAnimator {
            constructor() {
                this.isActive = true; // é»˜è®¤åŠ¨ç”»ä¸ºæ‰“å¼€çŠ¶æ€
                this.animationInterval = null;
                this.currentStep = 0;
                this.collaborationBubble = null;
                this.hasPlayedOnce = false; // æ–°å¢ï¼šæ ‡è®°æ˜¯å¦å·²ç»æ’­æ”¾è¿‡ä¸€æ¬¡
                
                // çŠ¶æ€ç®¡ç†
                this.activeTimeouts = new Set();
                this.isAnimationRunning = false;
                this.currentContent = '';
                this.targetContainer = null;
                this.lastScrollHeight = 0; // è®°å½•ä¸Šæ¬¡æ»šåŠ¨é«˜åº¦ï¼Œé˜²æ­¢é‡å¤æ»šåŠ¨
                
                // AIæ€è€ƒé˜¶æ®µå†…å®¹
                this.thinkingSteps = [
                    'æ­£åœ¨åˆ†æç”¨æˆ·éœ€æ±‚...',
                    'è®¾è®¡é¡µé¢å¸ƒå±€å’Œç»“æ„...',
                    'ç¼–å†™HTMLæ ‡ç­¾...',
                    'æ·»åŠ CSSæ ·å¼...',
                    'ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ...',
                    'æœ€ç»ˆæ£€æŸ¥å’Œå®Œå–„...'
                ];
                
                this.init();
            }
            
            init() {
                const claudeContainer = document.querySelector('.claude-output-container');
                
                // åˆ›å»ºåä½œæ°”æ³¡
                this.createCollaborationBubble();
                
                // è®¾ç½®å…¨å±€åŠ¨ç”»æ§åˆ¶
                this.setupGlobalAnimationControl();
                
                // åŠ¨ç”»é»˜è®¤å¼€å¯ï¼Œæ— éœ€åˆ‡æ¢æŒ‰é’®
                console.log('ClaudeåŠ¨ç”»ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œé»˜è®¤å¼€å¯');
            }
            
            setupGlobalAnimationControl() {
                const globalToggle = document.getElementById('globalAnimationToggle');
                if (globalToggle) {
                    globalToggle.addEventListener('click', () => {
                        this.isActive = !this.isActive;
                        globalToggle.classList.toggle('active', this.isActive);
                        
                        // æ›´æ–°å›¾æ ‡å’Œæ ‡ç­¾
                        const control = globalToggle.closest('.global-animation-control');
                        const icon = control.querySelector('.icon');
                        const label = control.querySelector('.label');
                        
                        if (this.isActive) {
                            icon.className = 'fas fa-play icon';
                            label.textContent = 'ClaudeåŠ¨ç”»';
                            console.log('ClaudeåŠ¨ç”»å·²å¼€å¯');
                        } else {
                            icon.className = 'fas fa-pause icon';
                            label.textContent = 'ClaudeåŠ¨ç”»';
                            this.stopAnimation();
                            this.hideBubble();
                            console.log('ClaudeåŠ¨ç”»å·²å…³é—­');
                        }
                    });
                }
            }
            
            createCollaborationBubble() {
                const claudeContainer = document.querySelector('.claude-output-container');
                
                this.collaborationBubble = document.createElement('div');
                this.collaborationBubble.className = 'claude-collaboration-bubble';
                this.collaborationBubble.innerHTML = `
                    <div class="bubble-avatar">C</div>
                    <span class="bubble-name">Claude</span>
                    <div class="bubble-status selecting"></div>
                `;
                
                claudeContainer.appendChild(this.collaborationBubble);
            }
            
            toggle() {
                this.isActive = !this.isActive;
                
                if (this.isActive) {
                    console.log('ClaudeåŠ¨ç”»å·²å¯ç”¨');
                    this.startAnimation();
                } else {
                    console.log('ClaudeåŠ¨ç”»å·²åœç”¨');
                    this.stopAnimation();
                    this.hideBubble();
                }
            }
            
            startAnimation() {
                if (this.animationInterval) return;
                
                // å¦‚æœå·²ç»æ’­æ”¾è¿‡ä¸€æ¬¡ï¼Œåˆ™ä¸å†è‡ªåŠ¨æ’­æ”¾
                if (this.hasPlayedOnce) {
                    console.log('ClaudeåŠ¨ç”»å·²æ’­æ”¾è¿‡ï¼Œç­‰å¾…æ–°å†…å®¹æˆ–æ‰‹åŠ¨è§¦å‘...');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å¯ä»¥æ¸²æŸ“
                const contentContainer = document.getElementById('claudeOutputContent');
                const iframe = contentContainer.querySelector('iframe');
                
                if (iframe && iframe.srcdoc) {
                    this.currentContent = iframe.srcdoc;
                    this.targetContainer = iframe;
                    this.runProgressiveRendering();
                } else {
                    // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
                    this.runThinkingAnimation();
                }
            }
            
            stopAnimation() {
                if (this.animationInterval) {
                    clearTimeout(this.animationInterval);
                    this.animationInterval = null;
                }
                
                // æ¸…ç†æ‰€æœ‰æ´»åŠ¨çš„timeout
                this.activeTimeouts.forEach(timeoutId => {
                    clearTimeout(timeoutId);
                });
                this.activeTimeouts.clear();
                
                // é‡ç½®çŠ¶æ€
                this.isAnimationRunning = false;
                this.lastScrollHeight = 0; // é‡ç½®æ»šåŠ¨é«˜åº¦è®°å½•
                
                // å¦‚æœæ­£åœ¨æ¸è¿›å¼æ¸²æŸ“ï¼Œæ¢å¤å®Œæ•´å†…å®¹
                if (this.targetContainer && this.currentContent) {
                    this.targetContainer.srcdoc = this.currentContent;
                }
            }
            
            // é‡ç½®åŠ¨ç”»çŠ¶æ€ï¼Œå…è®¸é‡æ–°æ’­æ”¾
            resetForNewContent() {
                this.hasPlayedOnce = false;
                this.stopAnimation();
                console.log('ClaudeåŠ¨ç”»çŠ¶æ€å·²é‡ç½®ï¼Œå‡†å¤‡æ’­æ”¾æ–°å†…å®¹...');
            }
            
            // å¯åŠ¨æ–°å†…å®¹çš„æ¸è¿›å¼æ¸²æŸ“
            startProgressiveRendering(newContent) {
                // æ£€æŸ¥å…¨å±€åŠ¨ç”»å¼€å…³æ˜¯å¦å¼€å¯
                if (!this.isActive) {
                    console.log('ClaudeåŠ¨ç”»å·²å…³é—­ï¼Œç›´æ¥æ˜¾ç¤ºå†…å®¹...');
                    this.showContentDirectly(newContent);
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„æ–°å†…å®¹
                if (this.currentContent === newContent && this.hasPlayedOnce) {
                    console.log('å†…å®¹æœªå˜åŒ–ä¸”å·²æ’­æ”¾è¿‡ï¼Œè·³è¿‡åŠ¨ç”»...');
                    return;
                }
                
                // åªæœ‰å†…å®¹æ”¹å˜æ—¶æ‰é‡ç½®çŠ¶æ€
                if (this.currentContent !== newContent) {
                    console.log('æ£€æµ‹åˆ°æ–°å†…å®¹ï¼Œé‡ç½®åŠ¨ç”»çŠ¶æ€...');
                    this.currentContent = newContent;
                    this.resetForNewContent();
                } else if (this.hasPlayedOnce) {
                    console.log('ç›¸åŒå†…å®¹å·²æ’­æ”¾è¿‡ï¼Œè·³è¿‡åŠ¨ç”»...');
                    return;
                }
                
                // æŸ¥æ‰¾ç›®æ ‡å®¹å™¨
                const contentContainer = document.getElementById('claudeOutputContent');
                const iframe = contentContainer.querySelector('iframe');
                if (iframe) {
                    this.targetContainer = iframe;
                    this.runProgressiveRendering();
                }
            }
            
            // ç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼ˆä¸æ’­æ”¾åŠ¨ç”»ï¼‰
            showContentDirectly(content) {
                const contentContainer = document.getElementById('claudeOutputContent');
                const iframe = contentContainer.querySelector('iframe');
                if (iframe) {
                    iframe.srcdoc = content;
                    console.log('å†…å®¹å·²ç›´æ¥æ˜¾ç¤ºï¼Œæ— åŠ¨ç”»æ•ˆæœ');
                }
            }
            
            async runThinkingAnimation() {
                if (!this.isActive) return;
                
                for (let i = 0; i < this.thinkingSteps.length; i++) {
                    if (!this.isActive) break;
                    
                    // æ˜¾ç¤ºæ€è€ƒæ°”æ³¡
                    this.showThinkingBubble(this.thinkingSteps[i]);
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´
                    await this.delay(2000);
                }
                
                // æ€è€ƒå®Œæˆåéšè—æ°”æ³¡ï¼Œä¸å†å¾ªç¯
                if (this.isActive) {
                    await this.delay(1000);
                    this.hideBubble();
                    this.hasPlayedOnce = true; // æ ‡è®°å·²æ’­æ”¾å®Œæˆ
                    console.log('Claudeæ€è€ƒåŠ¨ç”»æ’­æ”¾å®Œæˆ');
                }
            }
            
            async runProgressiveRendering() {
                if (!this.isActive || !this.currentContent) return;
                
                this.isAnimationRunning = true;
                
                // æ˜¾ç¤ºåˆ›ä½œæ°”æ³¡
                this.showCreationBubble();
                
                // ä½¿ç”¨é¢„æ¸²æŸ“æ–¹æ¡ˆï¼šå®Œæ•´å†…å®¹é¢„æ¸²æŸ“ + CSSæ§åˆ¶æ˜¾ç¤º
                await this.runPreRenderedAnimation();
                
                this.isAnimationRunning = false;
                
                // å®Œæˆåæ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                this.showCompletionBubble();
                
                // æ ‡è®°å·²æ’­æ”¾å®Œæˆ
                this.hasPlayedOnce = true;
                
                // åŠ¨ç”»æ’­æ”¾å®Œæ¯•ï¼Œä¿æŒå®ŒæˆçŠ¶æ€ï¼Œä¸å†å¾ªç¯
                console.log('ClaudeåŠ¨ç”»æ’­æ”¾å®Œæˆï¼Œç­‰å¾…æ–°å†…å®¹...');
            }
            
            // ===== æ–¹æ¡ˆ4æ”¹è¿›ç‰ˆï¼šå…¨é€æ˜æ¸²æŸ“ + é€æ­¥æ˜¾ç¤º =====
            
            // ä¸»è¦çš„é¢„æ¸²æŸ“åŠ¨ç”»æ‰§è¡Œå™¨ï¼ˆæ–¹æ¡ˆAç‰ˆæœ¬ï¼‰
            async runPreRenderedAnimation() {
                console.log('å¼€å§‹é¢„æ¸²æŸ“åŠ¨ç”»ï¼ˆæ–¹æ¡ˆAï¼‰...');
                
                // ç¬¬ä¸€æ­¥ï¼šé¢„å¤„ç†HTMLï¼Œåœ¨æ¯ä¸ªå…ƒç´ ä¸Šæ·»åŠ å†…è”é€æ˜æ ·å¼
                const fullContent = this.currentContent;
                const transparentContent = this.injectTransparencyStyles(fullContent);
                
                console.log('è®¾ç½®é¢„å¤„ç†åçš„å†…å®¹åˆ°iframe...');
                this.targetContainer.srcdoc = transparentContent;
                
                // ç¬¬äºŒæ­¥ï¼šç­‰å¾…iframeåŠ è½½å®Œæˆ
                await this.waitForIframeLoad();
                
                console.log('iframeåŠ è½½å®Œæˆï¼Œé¡µé¢åº”è¯¥å·²ç»æ˜¯é€æ˜çŠ¶æ€');
                
                // ç¬¬ä¸‰æ­¥ï¼šéªŒè¯é€æ˜çŠ¶æ€
                try {
                    const iframeDoc = this.targetContainer.contentDocument;
                    const firstElement = iframeDoc.querySelector('div, p, h1, h2, h3');
                    if (firstElement) {
                        const opacity = window.getComputedStyle(firstElement).opacity;
                        console.log('éªŒè¯ï¼šç¬¬ä¸€ä¸ªå…ƒç´ çš„é€æ˜åº¦ä¸º:', opacity);
                    }
                } catch (e) {
                    console.log('éªŒè¯é€æ˜çŠ¶æ€æ—¶å‡ºé”™:', e);
                }
                
                // ç¬¬å››æ­¥ï¼šåˆ›å»ºæ˜¾ç¤ºè®¡åˆ’
                const displayPlan = this.createElementDisplayPlan();
                
                console.log('æ˜¾ç¤ºè®¡åˆ’åˆ›å»ºå®Œæˆï¼Œå…ƒç´ æ•°é‡:', displayPlan.length);
                
                if (displayPlan.length === 0) {
                    console.log('è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•éœ€è¦æ˜¾ç¤ºçš„å…ƒç´ ï¼');
                    return;
                }
                
                // ç¬¬äº”æ­¥ï¼šé€æ­¥æ˜¾ç¤ºå…ƒç´ 
                await this.executeElementDisplay(displayPlan);
            }
            
            // åœ¨HTMLå†…å®¹ä¸­æ³¨å…¥é€æ˜æ ·å¼ï¼ˆæ–¹æ¡ˆAï¼šé¢„å¤„ç†HTMLç‰ˆæœ¬ï¼‰
            injectTransparencyStyles(htmlContent) {
                console.log('å¼€å§‹HTMLé¢„å¤„ç†ï¼Œç›´æ¥åœ¨å…ƒç´ ä¸Šæ·»åŠ å†…è”æ ·å¼...');
                
                // ç¬¬ä¸€æ­¥ï¼šæ·»åŠ åŸºç¡€CSS
                const basicCSS = `
<style id="claude-transparency-styles">
/* åŸºç¡€è¿‡æ¸¡æ ·å¼ */
body {
    opacity: 1 !important;
    background: white !important;
}

/* é¿å…å½±å“ç‰¹æ®Šå…ƒç´  */
script, style, meta, link, title, noscript, head {
    opacity: 1 !important;
}
</style>`;

                // ç¬¬äºŒæ­¥ï¼šé¢„å¤„ç†HTMLï¼Œç»™æ¯ä¸ªå¯è§å…ƒç´ æ·»åŠ å†…è”é€æ˜æ ·å¼
                let processedHTML = this.addInlineTransparencyToHTML(htmlContent);
                
                // ç¬¬ä¸‰æ­¥ï¼šæ³¨å…¥åŸºç¡€CSS
                if (processedHTML.includes('<head>')) {
                    processedHTML = processedHTML.replace('<head>', '<head>' + basicCSS);
                } else if (processedHTML.includes('<html')) {
                    processedHTML = processedHTML.replace(/(<html[^>]*>)/i, '$1' + basicCSS);
                } else {
                    processedHTML = basicCSS + processedHTML;
                }
                
                console.log('HTMLé¢„å¤„ç†å®Œæˆ');
                return processedHTML;
            }
            
            // æ ¸å¿ƒæ–¹æ³•ï¼šåœ¨HTMLå­—ç¬¦ä¸²ä¸­ç»™æ¯ä¸ªå…ƒç´ æ·»åŠ å†…è”é€æ˜æ ·å¼
            addInlineTransparencyToHTML(htmlContent) {
                console.log('æ­£åœ¨è§£æHTMLå¹¶æ·»åŠ å†…è”æ ·å¼...');
                
                // è¦å¤„ç†çš„HTMLæ ‡ç­¾ï¼ˆæ’é™¤ç‰¹æ®Šæ ‡ç­¾ï¼‰
                const tagsToProcess = [
                    'div', 'p', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'a', 'li', 'ul', 'ol', 'td', 'th', 'tr', 'table',
                    'img', 'svg', 'canvas', 'figure', 'figcaption',
                    'input', 'textarea', 'select', 'button',
                    'strong', 'em', 'code', 'pre', 'blockquote',
                    'section', 'article', 'header', 'footer', 'nav', 'main', 'aside'
                ];
                
                let processedHTML = htmlContent;
                let processedCount = 0;
                
                // éå†æ¯ç§æ ‡ç­¾ç±»å‹
                tagsToProcess.forEach(tag => {
                    // åŒ¹é…å¼€å§‹æ ‡ç­¾çš„æ­£åˆ™è¡¨è¾¾å¼
                    const tagRegex = new RegExp(`<${tag}([^>]*)>`, 'gi');
                    
                    processedHTML = processedHTML.replace(tagRegex, (match, attributes) => {
                        processedCount++;
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰styleå±æ€§
                        if (attributes.includes('style=')) {
                            // å¦‚æœå·²æœ‰styleï¼Œåœ¨ç°æœ‰æ ·å¼åæ·»åŠ é€æ˜åº¦
                            return match.replace(/style=["']([^"']*)["']/i, (styleMatch, existingStyles) => {
                                const transparencyStyle = 'opacity:0;transition:opacity 0.8s ease-in-out;';
                                return `style="${existingStyles};${transparencyStyle}"`;
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰styleï¼Œæ·»åŠ æ–°çš„styleå±æ€§
                            const transparencyStyle = ` style="opacity:0;transition:opacity 0.8s ease-in-out;"`;
                            return `<${tag}${attributes}${transparencyStyle}>`;
                        }
                    });
                });
                
                console.log(`å·²ä¸º ${processedCount} ä¸ªå…ƒç´ æ·»åŠ å†…è”é€æ˜æ ·å¼`);
                return processedHTML;
            }
            
            // ç›´æ¥è®¾ç½®æ‰€æœ‰å…ƒç´ ä¸ºé€æ˜
            async setAllElementsTransparent() {
                try {
                    const iframe = this.targetContainer;
                    if (!iframe || !iframe.contentWindow) return;
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc) return;
                    
                    // è·å–æ‰€æœ‰å…ƒç´ 
                    const allElements = iframeDoc.querySelectorAll('*');
                    let count = 0;
                    
                    allElements.forEach(element => {
                        const tagName = element.tagName.toLowerCase();
                        
                        // è·³è¿‡ä¸éœ€è¦å¤„ç†çš„å…ƒç´ 
                        if (['script', 'style', 'meta', 'link', 'title', 'noscript', 'head', 'html', 'body'].includes(tagName)) {
                            return;
                        }
                        
                        // ç›´æ¥è®¾ç½®å†…è”æ ·å¼
                        element.style.opacity = '0';
                        element.style.transition = 'opacity 0.8s ease-in-out';
                        element.classList.add('claude-element-transition');
                        count++;
                    });
                    
                    console.log(`å·²è®¾ç½® ${count} ä¸ªå…ƒç´ ä¸ºé€æ˜çŠ¶æ€`);
                    
                    // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ ·å¼åº”ç”¨
                    await this.delay(200);
                    
                } catch (error) {
                    console.log('è®¾ç½®å…ƒç´ é€æ˜æ—¶å‡ºé”™:', error);
                }
            }
            
            // åˆ›å»ºå…ƒç´ æ˜¾ç¤ºè®¡åˆ’ï¼ˆå¶å­èŠ‚ç‚¹ä¼˜å…ˆç‰ˆæœ¬ï¼‰
            createElementDisplayPlan() {
                try {
                    const iframe = this.targetContainer;
                    if (!iframe || !iframe.contentWindow) return [];
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc) return [];
                    
                    // è·å–æ‰€æœ‰å…ƒç´ 
                    const allElements = iframeDoc.querySelectorAll('*');
                    const plan = [];
                    
                    allElements.forEach((element, index) => {
                        const tagName = element.tagName.toLowerCase();
                        
                        // è·³è¿‡ä¸éœ€è¦æ˜¾ç¤ºçš„å…ƒç´ 
                        if (['script', 'style', 'meta', 'link', 'title', 'noscript', 'head', 'html', 'body'].includes(tagName)) {
                            return;
                        }
                        
                        // åªé€‰æ‹©å¶å­èŠ‚ç‚¹ï¼ˆæ²¡æœ‰å­å…ƒç´ ï¼‰æˆ–è€…åŒ…å«ç›´æ¥æ–‡æœ¬çš„å…ƒç´ 
                        const isLeafNode = element.children.length === 0;
                        const hasDirectText = this.hasDirectText(element);
                        const isVisualElement = ['IMG', 'SVG', 'CANVAS', 'INPUT', 'BUTTON', 'SELECT', 'TEXTAREA'].includes(element.tagName);
                        
                        // ä¼˜å…ˆé€‰æ‹©å¶å­èŠ‚ç‚¹æˆ–æœ‰ç›´æ¥æ–‡æœ¬å†…å®¹çš„å…ƒç´ 
                        if (isLeafNode || hasDirectText || isVisualElement) {
                            const hasContent = element.textContent && element.textContent.trim().length > 0;
                            
                            if (hasContent || isVisualElement) {
                                plan.push({
                                    element: element,
                                    index: index,
                                    delay: this.getDelayForElement(element),
                                    type: this.getElementType(element),
                                    content: element.textContent ? element.textContent.trim().substring(0, 30) + '...' : element.tagName,
                                    isLeaf: isLeafNode
                                });
                            }
                        }
                    });
                    
                    // æŒ‰DOMé¡ºåºæ’åºï¼Œå¶å­èŠ‚ç‚¹ä¼˜å…ˆ
                    plan.sort((a, b) => {
                        if (a.isLeaf !== b.isLeaf) {
                            return a.isLeaf ? -1 : 1; // å¶å­èŠ‚ç‚¹ä¼˜å…ˆ
                        }
                        return a.index - b.index;
                    });
                    
                    console.log(`æ‰¾åˆ° ${plan.length} ä¸ªå¶å­èŠ‚ç‚¹éœ€è¦æ¸è¿›æ˜¾ç¤º:`, plan.slice(0, 5).map(p => ({
                        tag: p.element.tagName,
                        content: p.content,
                        isLeaf: p.isLeaf
                    })));
                    
                    return plan;
                } catch (error) {
                    console.log('è·å–å…ƒç´ è®¡åˆ’æ—¶å‡ºé”™:', error);
                    return [];
                }
            }
            
            // æ‰§è¡Œå…ƒç´ æ˜¾ç¤ºï¼ˆå¢åŠ åŸºç¡€å»¶è¿Ÿè®©è¿‡ç¨‹æ›´æ˜æ˜¾ï¼‰
            async executeElementDisplay(plan) {
                for (let i = 0; i < plan.length; i++) {
                    if (!this.isActive) break;
                    
                    const step = plan[i];
                    
                    // æ˜¾ç¤ºå½“å‰å…ƒç´ 
                    this.showElement(step.element);
                    
                    // å¹³æ»‘æ»šåŠ¨åˆ°å…ƒç´ ä½ç½®
                    this.smoothScrollToElement(step.element);
                    
                    // æ›´æ–°æ°”æ³¡è¿›åº¦
                    this.updateBubbleProgress(i + 1, plan.length);
                    this.updateBubblePosition();
                    
                    // å‡æ…¢æ˜¾ç¤ºé€Ÿåº¦ï¼Œè®©è¿‡ç¨‹æ›´æ˜æ˜¾
                    const baseDelay = 500; // å¢åŠ åŸºç¡€å»¶è¿Ÿ
                    const elementDelay = Math.min(step.delay, 300); // å‡å°‘å˜åŠ¨èŒƒå›´
                    const randomDelay = Math.random() * 300; // é€‚åº¦éšæœº
                    const totalDelay = baseDelay + elementDelay + randomDelay;
                    
                    await this.delay(totalDelay);
                }
            }
            
            // æ£€æµ‹å…ƒç´ æ˜¯å¦åŒ…å«ç›´æ¥æ–‡æœ¬ï¼ˆä¸åŒ…æ‹¬å­å…ƒç´ æ–‡æœ¬ï¼‰
            hasDirectText(element) {
                for (let node of element.childNodes) {
                    if (node.nodeType === 3 && node.textContent.trim().length > 0) { // TEXT_NODE = 3
                        return true;
                    }
                }
                return false;
            }
            
            // æ˜¾ç¤ºç‰¹å®šå…ƒç´ ï¼ˆæ–¹æ¡ˆAç‰ˆæœ¬ - è¦†ç›–å†…è”æ ·å¼ï¼‰
            showElement(element) {
                try {
                    if (element) {
                        console.log('æ­£åœ¨æ˜¾ç¤ºå…ƒç´ :', element.tagName, element.textContent?.substring(0, 20));
                        
                        // é¦–å…ˆç¡®ä¿æ‰€æœ‰çˆ¶å®¹å™¨éƒ½æ˜¯å¯è§çš„
                        let parent = element.parentElement;
                        while (parent && parent !== this.targetContainer.contentDocument.body && parent !== this.targetContainer.contentDocument.documentElement) {
                            if (parent.style.opacity === '0' || parent.style.opacity === '') {
                                console.log('æ­£åœ¨æ˜¾ç¤ºçˆ¶å®¹å™¨:', parent.tagName);
                                parent.style.opacity = '1';
                                // çˆ¶å®¹å™¨ä½¿ç”¨æ›´å¿«çš„è¿‡æ¸¡
                                if (!parent.style.transition.includes('opacity')) {
                                    parent.style.transition = 'opacity 0.2s ease-in-out';
                                }
                            }
                            parent = parent.parentElement;
                        }
                        
                        // ç„¶åæ˜¾ç¤ºç›®æ ‡å…ƒç´ 
                        element.style.opacity = '1';
                        
                        // ç¡®ä¿è¿‡æ¸¡æ•ˆæœ
                        if (!element.style.transition.includes('opacity')) {
                            element.style.transition = 'opacity 0.8s ease-in-out';
                        }
                        
                        // éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸ
                        setTimeout(() => {
                            const currentOpacity = element.style.opacity;
                            console.log(`å…ƒç´  ${element.tagName} æ˜¾ç¤ºåé€æ˜åº¦:`, currentOpacity);
                        }, 100);
                    }
                } catch (error) {
                    console.log('æ˜¾ç¤ºå…ƒç´ æ—¶å‡ºé”™:', error);
                }
            }
            
            // å¹³æ»‘æ»šåŠ¨åˆ°å…ƒç´ 
            smoothScrollToElement(element) {
                try {
                    const iframe = this.targetContainer;
                    if (!iframe || !iframe.contentWindow || !element) return;
                    
                    const iframeWindow = iframe.contentWindow;
                    const elementTop = element.offsetTop;
                    const viewportHeight = iframeWindow.innerHeight || 400;
                    
                    // æ™ºèƒ½æ»šåŠ¨ï¼šå°†å…ƒç´ æ»šåŠ¨åˆ°è§†çª—çš„1/3ä½ç½®
                    const targetScroll = Math.max(0, elementTop - viewportHeight / 3);
                    
                    iframeWindow.scrollTo({
                        top: targetScroll,
                        behavior: 'smooth'
                    });
                } catch (error) {
                    // å¿½ç•¥è·¨åŸŸé”™è¯¯
                }
            }
            
            // æ ¹æ®å…ƒç´ ç±»å‹è·å–å»¶è¿Ÿæ—¶é—´ï¼ˆä¸ºç»†ç²’åº¦æ˜¾ç¤ºä¼˜åŒ–ï¼‰
            getDelayForElement(element) {
                const tagName = element.tagName.toLowerCase();
                const delays = {
                    'h1': 400, 'h2': 350, 'h3': 300, 'h4': 250, 'h5': 200, 'h6': 150,
                    'p': 300,
                    'div': 200,
                    'span': 150,
                    'strong': 150,
                    'em': 150,
                    'a': 150,
                    'li': 200,
                    'ul': 300, 'ol': 300,
                    'blockquote': 400,
                    'pre': 500,
                    'code': 200,
                    'img': 300,
                    'svg': 250,
                    'canvas': 300,
                    'table': 400,
                    'tr': 200,
                    'td': 150, 'th': 150,
                    'section': 300,
                    'article': 350,
                    'input': 200,
                    'button': 200,
                    'textarea': 250,
                    'select': 200
                };
                return delays[tagName] || 200;
            }
            
            // è·å–å…ƒç´ ç±»å‹
            getElementType(element) {
                const tagName = element.tagName.toLowerCase();
                if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
                    return 'heading';
                } else if (tagName === 'p') {
                    return 'paragraph';
                } else if (['ul', 'ol'].includes(tagName)) {
                    return 'list';
                } else if (tagName === 'img') {
                    return 'image';
                } else if (['pre', 'code'].includes(tagName)) {
                    return 'code';
                } else {
                    return 'content';
                }
            }
            parseHTMLIntoChunks(htmlContent) {
                // æ™ºèƒ½åˆ†å‰²HTMLå†…å®¹
                const chunks = [];
                
                // é¦–å…ˆæ·»åŠ DOCTYPEå’Œhtmlå¼€å§‹æ ‡ç­¾
                if (htmlContent.includes('<!DOCTYPE')) {
                    chunks.push('<!DOCTYPE html>');
                    htmlContent = htmlContent.replace('<!DOCTYPE html>', '');
                }
                
                // åˆ†å‰²ä¸»è¦HTMLæ ‡ç­¾
                const majorTags = ['<html', '<head', '<style', '<body', '<header', '<nav', '<main', '<section', '<article', '<div', '<footer'];
                
                let currentPos = 0;
                let currentChunk = '';
                
                while (currentPos < htmlContent.length) {
                    let nextTagPos = htmlContent.length;
                    let foundTag = null;
                    
                    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªä¸»è¦æ ‡ç­¾çš„ä½ç½®
                    for (const tag of majorTags) {
                        const pos = htmlContent.indexOf(tag, currentPos);
                        if (pos !== -1 && pos < nextTagPos) {
                            nextTagPos = pos;
                            foundTag = tag;
                        }
                    }
                    
                    // å¦‚æœæ‰¾åˆ°äº†æ ‡ç­¾ï¼Œåˆ†å‰²å†…å®¹
                    if (foundTag && nextTagPos > currentPos) {
                        currentChunk += htmlContent.substring(currentPos, nextTagPos);
                        if (currentChunk.trim()) {
                            chunks.push(currentChunk);
                        }
                        
                        // æ‰¾åˆ°å®Œæ•´çš„æ ‡ç­¾ï¼ˆåŒ…æ‹¬ç»“æŸæ ‡ç­¾ï¼‰
                        const tagEnd = this.findCompleteTag(htmlContent, nextTagPos);
                        currentChunk = htmlContent.substring(nextTagPos, tagEnd);
                        currentPos = tagEnd;
                    } else {
                        // æ²¡æœ‰æ›´å¤šæ ‡ç­¾ï¼Œæ·»åŠ å‰©ä½™å†…å®¹
                        currentChunk += htmlContent.substring(currentPos);
                        break;
                    }
                }
                
                if (currentChunk.trim()) {
                    chunks.push(currentChunk);
                }
                
                // ç¡®ä¿è‡³å°‘æœ‰ä¸€äº›chunk
                if (chunks.length === 0) {
                    const lines = htmlContent.split('\n');
                    for (let i = 0; i < lines.length; i += 3) {
                        chunks.push(lines.slice(i, i + 3).join('\n'));
                    }
                }
                
                return chunks.filter(chunk => chunk.trim());
            }
            
            findCompleteTag(html, startPos) {
                // ç®€åŒ–å®ç°ï¼šæ‰¾åˆ°ä¸‹ä¸€ä¸ª>ä½ç½®
                const closePos = html.indexOf('>', startPos);
                return closePos !== -1 ? closePos + 1 : startPos + 50;
            }
            
            showThinkingBubble(message) {
                if (!this.collaborationBubble) return;
                
                // æ›´æ–°æ°”æ³¡å†…å®¹
                const nameSpan = this.collaborationBubble.querySelector('.bubble-name');
                nameSpan.textContent = message;
                
                // æ˜¾ç¤ºåœ¨Claudeå®¹å™¨å³ä¸Šè§’
                this.positionBubbleAtContainer();
                this.updateBubbleStatus('thinking');
                this.collaborationBubble.classList.add('active', 'floating');
            }
            
            showCreationBubble() {
                if (!this.collaborationBubble) return;
                
                const nameSpan = this.collaborationBubble.querySelector('.bubble-name');
                nameSpan.textContent = 'æ­£åœ¨åˆ›å»ºç½‘é¡µ...';
                
                this.positionBubbleAtContainer();
                this.updateBubbleStatus('typing');
                this.collaborationBubble.classList.add('active', 'floating');
            }
            
            updateBubbleProgress(current, total) {
                if (!this.collaborationBubble) return;
                
                const nameSpan = this.collaborationBubble.querySelector('.bubble-name');
                nameSpan.textContent = `æ¸²æŸ“è¿›åº¦ ${current}/${total}`;
            }
            
            showCompletionBubble() {
                if (!this.collaborationBubble) return;
                
                const nameSpan = this.collaborationBubble.querySelector('.bubble-name');
                nameSpan.textContent = 'ç½‘é¡µåˆ›å»ºå®Œæˆï¼';
                
                this.updateBubbleStatus('selecting');
            }
            
            positionBubbleAtContainer() {
                if (!this.collaborationBubble) return;
                
                const claudeContainer = document.querySelector('.claude-output-container');
                const containerRect = claudeContainer.getBoundingClientRect();
                
                // å®šä½åœ¨å®¹å™¨å³ä¸Šè§’å†…éƒ¨
                const bubbleWidth = 200;
                const x = claudeContainer.clientWidth - bubbleWidth - 20;
                const y = 80; // å·¥å…·æ ä¸‹æ–¹
                
                this.collaborationBubble.style.left = x + 'px';
                this.collaborationBubble.style.top = y + 'px';
                this.collaborationBubble.style.setProperty('--arrow-direction', 'down');
            }
            
            updateBubbleStatus(status) {
                const statusDot = this.collaborationBubble.querySelector('.bubble-status');
                statusDot.className = `bubble-status ${status}`;
            }
            
            hideBubble() {
                if (this.collaborationBubble) {
                    this.collaborationBubble.classList.remove('active', 'floating');
                }
            }
            
            // ç­‰å¾…iframeå†…å®¹åŠ è½½å®Œæˆ
            async waitForIframeLoad() {
                return new Promise(resolve => {
                    // å¢åŠ å»¶è¿Ÿï¼Œç¡®ä¿iframeå†…å®¹å®Œå…¨åŠ è½½å¹¶æ¸²æŸ“
                    setTimeout(resolve, 500);
                });
            }
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æ–°ç”Ÿæˆçš„å†…å®¹ï¼ˆæ™ºèƒ½é˜²æŠ–åŠ¨ç‰ˆæœ¬ï¼‰
            scrollToNewContent() {
                try {
                    const iframe = this.targetContainer;
                    if (!iframe || !iframe.contentWindow) return;
                    
                    const iframeWindow = iframe.contentWindow;
                    const iframeDoc = iframe.contentDocument || iframeWindow.document;
                    
                    if (!iframeDoc || !iframeDoc.body) return;
                    
                    // è·å–å†…å®¹é«˜åº¦ä¿¡æ¯
                    const scrollHeight = Math.max(
                        iframeDoc.documentElement.scrollHeight,
                        iframeDoc.body.scrollHeight,
                        iframeDoc.documentElement.offsetHeight,
                        iframeDoc.body.offsetHeight
                    );
                    
                    const clientHeight = iframeWindow.innerHeight || iframe.clientHeight;
                    const currentScrollTop = iframeWindow.pageYOffset || iframeDoc.documentElement.scrollTop || iframeDoc.body.scrollTop || 0;
                    
                    // å¦‚æœå†…å®¹é«˜åº¦ä¸è¶³ä¸€å±ï¼Œä¸éœ€è¦æ»šåŠ¨
                    if (scrollHeight <= clientHeight + 50) return;
                    
                    // è®°å½•ä¸Šæ¬¡çš„æ»šåŠ¨é«˜åº¦ï¼Œé¿å…é‡å¤æ»šåŠ¨
                    if (!this.lastScrollHeight) {
                        this.lastScrollHeight = 0;
                    }
                    
                    // åªæœ‰å½“å†…å®¹é«˜åº¦æ˜æ˜¾å¢åŠ æ—¶æ‰æ»šåŠ¨ï¼ˆé˜²æ­¢é¢‘ç¹çš„å°å¹…æ»šåŠ¨ï¼‰
                    const heightDelta = scrollHeight - this.lastScrollHeight;
                    if (heightDelta < 100) return; // å†…å®¹å¢åŠ ä¸è¶³100pxæ—¶ä¸æ»šåŠ¨
                    
                    // è®¡ç®—æ˜¯å¦éœ€è¦æ»šåŠ¨ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦èƒ½çœ‹åˆ°æ–°å†…å®¹
                    const viewportBottom = currentScrollTop + clientHeight;
                    const needScroll = scrollHeight > viewportBottom + 200; // ç»™200pxç¼“å†²åŒº
                    
                    if (!needScroll) {
                        this.lastScrollHeight = scrollHeight;
                        return;
                    }
                    
                    // æ™ºèƒ½æ»šåŠ¨ç­–ç•¥ï¼šåŸºäºå½“å‰ä½ç½®å¹³æ»‘å‘ä¸‹æ»šåŠ¨
                    const contentRatio = scrollHeight / clientHeight;
                    let scrollAmount;
                    
                    if (contentRatio < 1.5) {
                        // å†…å®¹ä¸å¤šæ—¶ï¼Œå°æ­¥æ»šåŠ¨
                        scrollAmount = Math.min(heightDelta, clientHeight * 0.3);
                    } else if (contentRatio < 3) {
                        // ä¸­ç­‰å†…å®¹ï¼Œä¸­æ­¥æ»šåŠ¨
                        scrollAmount = Math.min(heightDelta, clientHeight * 0.5);
                    } else {
                        // é•¿å†…å®¹ï¼Œå¤§æ­¥æ»šåŠ¨ä½†ä¸è¶…è¿‡æ–°å¢å†…å®¹
                        scrollAmount = Math.min(heightDelta * 1.2, clientHeight * 0.7);
                    }
                    
                    const targetScroll = Math.min(
                        currentScrollTop + scrollAmount,
                        scrollHeight - clientHeight
                    );
                    
                    // åªæœ‰ç›®æ ‡ä½ç½®ä¸å½“å‰ä½ç½®æœ‰æ˜æ˜¾å·®å¼‚æ—¶æ‰æ»šåŠ¨
                    if (Math.abs(targetScroll - currentScrollTop) > 50) {
                        iframeWindow.scrollTo({
                            top: targetScroll,
                            behavior: 'smooth'
                        });
                    }
                    
                    this.lastScrollHeight = scrollHeight;
                    
                } catch (error) {
                    // å¿½ç•¥è·¨åŸŸæˆ–å…¶ä»–æ»šåŠ¨é”™è¯¯ï¼Œè¿™åœ¨iframeä¸­æ˜¯å¸¸è§çš„
                    // console.log('æ»šåŠ¨æ—¶å‡ºç°è·¨åŸŸé™åˆ¶ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡');
                }
            }
            
            // æ›´æ–°æ°”æ³¡ä½ç½®ä»¥è·Ÿéšæ»šåŠ¨è¿›åº¦
            updateBubblePosition() {
                // æ°”æ³¡ä¿æŒåœ¨Claudeå®¹å™¨çš„å›ºå®šä½ç½®ï¼Œä¸è·Ÿéšiframeå†…éƒ¨æ»šåŠ¨
                // è¿™æ ·ç”¨æˆ·å§‹ç»ˆèƒ½çœ‹åˆ°Claudeçš„åˆ›ä½œçŠ¶æ€
                this.positionBubbleAtContainer();
            }
            
            delay(ms) {
                return new Promise(resolve => {
                    const timeoutId = setTimeout(resolve, ms);
                    this.activeTimeouts.add(timeoutId);
                });
            }
            
            // å…¬å…±æ–¹æ³•ï¼šå¤–éƒ¨è°ƒç”¨ä»¥å¼€å§‹æ¸è¿›å¼æ¸²æŸ“
            startProgressiveRendering(htmlContent) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
                const hasNewContent = this.currentContent !== htmlContent;
                
                this.currentContent = htmlContent;
                const contentContainer = document.getElementById('claudeOutputContent');
                const iframe = contentContainer.querySelector('iframe');
                this.targetContainer = iframe;
                
                if (this.isActive && hasNewContent) {
                    console.log('æ£€æµ‹åˆ°æ–°å†…å®¹ï¼Œé‡å¯ClaudeåŠ¨ç”»...');
                    // åœæ­¢å½“å‰åŠ¨ç”»
                    this.stopAnimation();
                    // é‡æ–°å¼€å§‹æ¸²æŸ“åŠ¨ç”»
                    this.runProgressiveRendering();
                }
            }
        }
        
        // åˆå§‹åŒ–åä½œåŠ¨ç”»ç³»ç»Ÿ
        let excelAnimator;
        let wordAnimator;
        let claudeAnimator;
        
        // åˆå§‹åŒ–ï¼šéšè—å¯¹è¯å†å²åŒºåŸŸ
        chatMessages.classList.add('empty');

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // å›è½¦å‘é€æ¶ˆæ¯
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendButton.addEventListener('click', sendMessage);

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // ç¦ç”¨å‘é€æŒ‰é’®
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            addMessage(message, 'user');
            
            // æ·»åŠ åˆ°å¯¹è¯å†å²
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæµå¼æ›´æ–°ï¼‰
            const aiMessageDiv = createAIMessageContainer();
            let fullResponse = '';

            try {
                let finalMessage = message;
                
                // è·å–é€‰ä¸­çš„æ–‡æ¡£å†…å®¹
                const selectedDocs = getSelectedDocumentsContent();
                
                // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡æ¡£ï¼Œå°†å®ƒä»¬ä½œä¸ºé™„ä»¶æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                if (selectedDocs.length > 0) {
                    finalMessage += "\n\n--- é™„ä»¶æ–‡æ¡£ ---\n";
                    selectedDocs.forEach((doc, index) => {
                        finalMessage += `\né™„ä»¶ ${index + 1}: ${doc.title} (${doc.type})\n`;
                        finalMessage += "å†…å®¹:\n" + doc.content + "\n";
                        finalMessage += "-".repeat(50) + "\n";
                    });
                    finalMessage += "\nè¯·åŸºäºä»¥ä¸Šé™„ä»¶å†…å®¹æ¥å›ç­”æˆ‘çš„é—®é¢˜ã€‚";
                }
                
                // å¦‚æœç”¨æˆ·è¯·æ±‚åˆ›å»ºæ–‡æ¡£ï¼Œæ·»åŠ HTMLæ ¼å¼è¦æ±‚
                if (isDocumentCreationRequest(message)) {
                    finalMessage += "\n\nPlease create this as a complete HTML document with proper styling using CSS. Include all necessary HTML structure (<!DOCTYPE html>, <html>, <head>, <body>, etc.)";
                }
                
                // è°ƒç”¨åç«¯API (æµå¼)
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: finalMessage,
                        history: conversationHistory.slice(0, -1) // ä¸åŒ…å«å½“å‰æ¶ˆæ¯
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.slice(6);
                            if (jsonStr.trim() === '') continue;

                            try {
                                const data = JSON.parse(jsonStr);
                                
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                
                                if (data.content) {
                                    fullResponse += data.content;
                                    updateAIMessage(aiMessageDiv, fullResponse);
                                }
                                
                                if (data.done) {
                                    // æµå¼å“åº”å®Œæˆ
                                    break;
                                }
                            } catch (parseError) {
                                if (jsonStr.trim() !== '') {
                                    console.warn('Failed to parse JSON:', jsonStr);
                                }
                            }
                        }
                    }
                }

                // æ·»åŠ å®Œæ•´å›å¤åˆ°å¯¹è¯å†å²ï¼ˆä½¿ç”¨åŸå§‹æ¶ˆæ¯ï¼Œä¸æ˜¯ä¿®æ”¹åçš„ï¼‰
                conversationHistory.push({
                    role: 'assistant',
                    content: fullResponse
                });

                // å¦‚æœå›å¤åŒ…å«ä»£ç æˆ–HTMLï¼Œæˆ–è€…æ˜¯æ–‡æ¡£åˆ›å»ºè¯·æ±‚ï¼Œæ˜¾ç¤ºåœ¨Claudeè¾“å‡ºå®¹å™¨ä¸­
                if (isWebContent(fullResponse) || isDocumentCreationRequest(message)) {
                    showClaudeOutput(fullResponse, isDocumentCreationRequest(message));
                }
                
            } catch (error) {
                console.error('Error calling Claude API:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                let errorMessage = 'æŠ±æ­‰ï¼Œè¿æ¥AIæœåŠ¡æ—¶å‡ºç°é—®é¢˜ã€‚';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'æ— æ³•è¿æ¥åˆ°AIæœåŠ¡ã€‚è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (python server.py)ã€‚';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = 'AIæœåŠ¡å“åº”é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                } else {
                    errorMessage = `é”™è¯¯: ${error.message}`;
                }
                
                // å¦‚æœå·²ç»åˆ›å»ºäº†AIæ¶ˆæ¯å®¹å™¨ï¼Œæ›´æ–°å®ƒæ˜¾ç¤ºé”™è¯¯
                if (aiMessageDiv) {
                    updateAIMessage(aiMessageDiv, errorMessage);
                } else {
                    addMessage(errorMessage, 'ai');
                }
            } finally {
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        function createAIMessageContainer() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = '';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageContent;
        }

        function updateAIMessage(messageElement, content) {
            messageElement.textContent = content;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'U' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // æ˜¾ç¤ºå¯¹è¯å†å²åŒºåŸŸï¼ˆç§»é™¤emptyç±»ï¼‰
            chatMessages.classList.remove('empty');

            // åªæœ‰å½“AIå›å¤åŒ…å«HTML/ç½‘é¡µå†…å®¹æ—¶æ‰æ˜¾ç¤ºClaudeå®¹å™¨
            if (type === 'ai' && isWebContent(content)) {
                showClaudeOutput(content);
            } else if (type === 'ai') {
                // å¦‚æœAIå›å¤ä¸æ˜¯ç½‘é¡µå†…å®¹ï¼Œéšè—Claudeå®¹å™¨
                hideClaudeOutput();
            }
        }

        // è·å–é€‰ä¸­æ–‡æ¡£çš„å†…å®¹
        function getSelectedDocumentsContent() {
            const selectedDocs = [];
            
            // æ£€æŸ¥Excelå®¹å™¨æ˜¯å¦è¢«é€‰ä¸­
            const excelContainer = document.querySelector('.excel-container');
            if (excelContainer && excelContainer.classList.contains('selected')) {
                const excelContent = extractExcelContent();
                if (excelContent) {
                    selectedDocs.push({
                        type: 'excel',
                        title: 'PPT Template Search Data',
                        content: excelContent
                    });
                }
            }
            
            // æ£€æŸ¥Wordå®¹å™¨æ˜¯å¦è¢«é€‰ä¸­
            const wordContainer = document.querySelector('.word-container');
            if (wordContainer && wordContainer.classList.contains('selected')) {
                const wordContent = extractWordContent();
                if (wordContent) {
                    selectedDocs.push({
                        type: 'word',
                        title: 'PPT Template User Research Report',
                        content: wordContent
                    });
                }
            }
            
            // æ£€æŸ¥Claudeå®¹å™¨æ˜¯å¦è¢«é€‰ä¸­
            const claudeContainer = document.getElementById('claudeOutputContainer');
            if (claudeContainer && claudeContainer.classList.contains('selected')) {
                const claudeContent = extractClaudeContent();
                if (claudeContent) {
                    selectedDocs.push({
                        type: 'claude_output',
                        title: 'Claude Task Output',
                        content: claudeContent
                    });
                }
            }
            
            return selectedDocs;
        }

        // æå–Excelå†…å®¹
        function extractExcelContent() {
            const table = document.querySelector('.excel-table');
            if (!table) return null;
            
            let content = "PPT Template Search Data:\n\n";
            const rows = table.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim());
                
                if (index === 0) {
                    content += rowData.join(' | ') + '\n';
                    content += '-'.repeat(50) + '\n';
                } else {
                    content += rowData.join(' | ') + '\n';
                }
            });
            
            return content;
        }

        // æå–Wordå†…å®¹
        function extractWordContent() {
            const wordDocument = document.querySelector('.word-document');
            if (!wordDocument) return null;
            
            let content = "PPT Template User Research Report\n";
            content += "Market Analysis & User Behavior Study | December 2024\n\n";
            
            const sections = wordDocument.querySelectorAll('.word-section');
            sections.forEach(section => {
                const heading = section.querySelector('h3');
                if (heading) {
                    content += heading.textContent + '\n';
                    content += '='.repeat(heading.textContent.length) + '\n';
                }
                
                const paragraphs = section.querySelectorAll('p');
                paragraphs.forEach(p => {
                    content += p.textContent + '\n\n';
                });
                
                const lists = section.querySelectorAll('ul, ol');
                lists.forEach(list => {
                    const items = list.querySelectorAll('li');
                    items.forEach(item => {
                        content += 'â€¢ ' + item.textContent + '\n';
                    });
                    content += '\n';
                });
            });
            
            return content;
        }

        // æå–Claudeè¾“å‡ºå†…å®¹
        function extractClaudeContent() {
            const claudeContent = document.getElementById('claudeOutputContent');
            if (!claudeContent) return null;
            
            const iframe = claudeContent.querySelector('iframe');
            if (iframe) {
                try {
                    // å°è¯•è·å–iframeå†…å®¹
                    return iframe.srcdoc || 'Claude generated HTML content (iframe)';
                } catch (e) {
                    return 'Claude generated content (unable to extract due to security restrictions)';
                }
            }
            
            return claudeContent.textContent.trim() || null;
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¦æ±‚åˆ›å»ºæ–‡æ¡£
        function isDocumentCreationRequest(message) {
            const messageLower = message.toLowerCase();
            
            // ä¾‹å¤–æƒ…å†µï¼šå¦‚æœæ˜¯å­¦ä¹ æ¨¡æ¿çš„è¯·æ±‚ï¼Œä¸è§¦å‘æ–‡æ¡£åˆ›å»ºæ¨¡å¼
            if (messageLower.includes('learn this as template') || 
                messageLower.includes('learn this template') ||
                messageLower.includes('study this template')) {
                return false;
            }
            
            const documentKeywords = [
                'slide', 'slides', 'presentation', 'ppt', 'powerpoint',
                'word', 'document', 'doc', 'docx', 
                'excel', 'spreadsheet', 'table', 'xlsx',
                'create', 'make', 'generate', 'build', 'design'
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«åˆ›å»ºæ–‡æ¡£çš„å…³é”®è¯ç»„åˆ
            const hasDocumentKeyword = documentKeywords.some(keyword => 
                messageLower.includes(keyword));
            
            const hasCreationKeyword = ['create', 'make', 'generate', 'build', 'design'].some(keyword =>
                messageLower.includes(keyword));
            
            return hasDocumentKeyword && (hasCreationKeyword || 
                messageLower.includes('create') || 
                messageLower.includes('make') ||
                messageLower.includes('generate') ||
                messageLower.includes('build') ||
                messageLower.includes('design'));
        }

        function isWebContent(content) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«HTMLä»£ç å—æˆ–HTMLæ ‡ç­¾
            const hasHtmlCodeBlock = content.includes('```html') || content.includes('```HTML');
            const hasHtmlTags = content.includes('<') && content.includes('>');
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§çš„HTMLå…ƒç´ 
            const htmlElements = ['<html', '<div', '<p>', '<span', '<h1', '<h2', '<h3', 
                                 '<button', '<input', '<form', '<style', '<script', 
                                 '<header', '<footer', '<nav', '<section', '<article'];
            
            const hasHtmlElements = htmlElements.some(tag => 
                content.toLowerCase().includes(tag.toLowerCase()));
            
            return (hasHtmlCodeBlock || hasHtmlTags) && hasHtmlElements;
        }

        function extractHtmlContent(content) {
            // æ–¹æ³•1: æå– ```html ä»£ç å—
            const htmlCodeBlockRegex = /```html\s*([\s\S]*?)\s*```/i;
            const htmlCodeMatch = content.match(htmlCodeBlockRegex);
            if (htmlCodeMatch) {
                return htmlCodeMatch[1].trim();
            }
            
            // æ–¹æ³•2: æå– ``` ä»£ç å—ï¼ˆå¯èƒ½ä¸æ ‡æ³¨htmlï¼‰
            const codeBlockRegex = /```\s*([\s\S]*?)\s*```/;
            const codeMatch = content.match(codeBlockRegex);
            if (codeMatch) {
                const codeContent = codeMatch[1].trim();
                // æ£€æŸ¥æ˜¯å¦æ˜¯HTMLå†…å®¹
                if (codeContent.includes('<') && codeContent.includes('>')) {
                    return codeContent;
                }
            }
            
            // æ–¹æ³•3: æå–ä»<!DOCTYPEæˆ–<htmlå¼€å§‹çš„å®Œæ•´HTML
            const htmlDocRegex = /(<!DOCTYPE[\s\S]*)/i;
            const htmlDocMatch = content.match(htmlDocRegex);
            if (htmlDocMatch) {
                return htmlDocMatch[1].trim();
            }
            
            // æ–¹æ³•4: æå–æœ€å¤§çš„HTMLæ ‡ç­¾å—
            const htmlTagRegex = /(<[^>]+>[\s\S]*?<\/[^>]+>)/;
            const htmlTagMatch = content.match(htmlTagRegex);
            if (htmlTagMatch) {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ ‡ç­¾åï¼Œå°è¯•æå–æ•´ä¸ªHTMLç»“æ„
                const startIndex = content.indexOf(htmlTagMatch[1]);
                const possibleHtml = content.substring(startIndex);
                
                // ç®€å•çš„HTMLç»“æ„æå–
                let htmlContent = '';
                let tagStack = [];
                let i = 0;
                
                while (i < possibleHtml.length) {
                    if (possibleHtml[i] === '<') {
                        const tagEnd = possibleHtml.indexOf('>', i);
                        if (tagEnd !== -1) {
                            const tag = possibleHtml.substring(i, tagEnd + 1);
                            htmlContent += tag;
                            
                            // ç®€å•çš„æ ‡ç­¾åŒ¹é…æ£€æŸ¥
                            if (tag.includes('</')) {
                                tagStack.pop();
                            } else if (!tag.includes('/>') && !tag.includes('<br') && !tag.includes('<hr')) {
                                tagStack.push(tag);
                            }
                            
                            i = tagEnd + 1;
                            
                            // å¦‚æœæ ‡ç­¾æ ˆä¸ºç©ºä¸”æˆ‘ä»¬å·²ç»æœ‰å†…å®¹ï¼Œè¯´æ˜HTMLç»“æ„å®Œæ•´
                            if (tagStack.length === 0 && htmlContent.length > 50) {
                                break;
                            }
                        } else {
                            htmlContent += possibleHtml[i];
                            i++;
                        }
                    } else {
                        htmlContent += possibleHtml[i];
                        i++;
                    }
                }
                
                if (htmlContent.trim()) {
                    return htmlContent.trim();
                }
            }
            
            // å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œè¿”å›åŸå†…å®¹
            return content;
        }

        function showClaudeOutput(content, isDocumentRequest = false) {
            const claudeContainer = document.getElementById('claudeOutputContainer');
            const claudeContent = document.getElementById('claudeOutputContent');
            const claudeTitle = document.getElementById('claudeTaskTitle');
            
            // æå–HTMLå†…å®¹
            let htmlContent = extractHtmlContent(content);
            
            // å¦‚æœæ˜¯æ–‡æ¡£åˆ›å»ºè¯·æ±‚ä½†æ²¡æœ‰æå–åˆ°HTMLï¼Œå°è¯•ç›´æ¥ä½¿ç”¨å†…å®¹
            if (isDocumentRequest && !htmlContent.includes('<html')) {
                // å¦‚æœå†…å®¹åŒ…å«HTMLæ ‡ç­¾ä½†ä¸æ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ŒåŒ…è£…å®ƒ
                if (content.includes('<') && content.includes('>')) {
                    htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Document</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
    </style>
</head>
<body>
    ${content}
</body>
</html>`;
                }
            }
            
            // æ›´æ–°æ ‡é¢˜
            if (isDocumentRequest) {
                claudeTitle.textContent = 'Generated Document';
            } else {
                claudeTitle.textContent = 'Generated Web Content';
            }
            
            // æ˜¾ç¤ºå®¹å™¨
            claudeContainer.style.display = 'block';
            
            // åˆ›å»ºiframeæ¥æ˜¾ç¤ºHTMLå†…å®¹
            const iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.background = 'white';
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹å¹¶æ·»åŠ iframe
            claudeContent.innerHTML = '';
            claudeContent.appendChild(iframe);
            
            // è®¾ç½®iframeçš„srcdocå±æ€§ä»¥ä¾¿åŠ¨ç”»ç³»ç»Ÿè®¿é—®
            iframe.srcdoc = htmlContent;
            
            // å¦‚æœClaudeåŠ¨ç”»ç³»ç»Ÿæ¿€æ´»ï¼Œå¯åŠ¨æ¸è¿›å¼æ¸²æŸ“
            if (claudeAnimator && claudeAnimator.isActive) {
                claudeAnimator.startProgressiveRendering(htmlContent);
            } else {
                // æ­£å¸¸æ˜¾ç¤ºå®Œæ•´å†…å®¹
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(htmlContent);
                iframeDoc.close();
            }
        }

        function hideClaudeOutput() {
            const claudeContainer = document.getElementById('claudeOutputContainer');
            claudeContainer.style.display = 'none';
        }

        // æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('âœ… åç«¯æœåŠ¡è¿æ¥æ­£å¸¸');
                    // æ›´æ–°èŠå¤©è¾“å…¥æ¡†å ä½ç¬¦
                    chatInput.placeholder = 'Ask Clippy Anything';
                    return true;
                }
            } catch (error) {
                console.log('âŒ åç«¯æœåŠ¡æœªè¿æ¥');
                // æ›´æ–°èŠå¤©è¾“å…¥æ¡†å ä½ç¬¦
                chatInput.placeholder = 'è¯·å…ˆå¯åŠ¨åç«¯æœåŠ¡ (python server.py)';
                return false;
            }
            return false;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // æ£€æŸ¥æœåŠ¡çŠ¶æ€
            checkServerStatus();
        });

        // æ‹–æ‹½åŠŸèƒ½
        let isDragging = false;
        let currentElement = null;
        let offset = { x: 0, y: 0 };
        let selectedDocuments = new Set();
        let mouseDownPos = { x: 0, y: 0 };
        let mouseDownTarget = null;
        const DRAG_THRESHOLD = 5;

        // è°ƒæ•´å¤§å°ç›¸å…³å˜é‡
        let isResizing = false;
        let currentResizeTarget = null;
        let resizeDirection = null;
        let originalRect = {};
        let startPos = {};

        // ä¸ºæ–‡æ¡£å®¹å™¨æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const excelContainer = document.querySelector('.excel-container');
            const wordContainer = document.querySelector('.word-container');
            const claudeContainer = document.getElementById('claudeOutputContainer');

            // ä¸ºæ–‡æ¡£å®¹å™¨æ·»åŠ æ‹–æ‹½äº‹ä»¶
            [excelContainer, wordContainer, claudeContainer].forEach(element => {
                element.addEventListener('mousedown', handleMouseDown);
                
                // ä¸ºè°ƒæ•´å¤§å°æ‰‹æŸ„æ·»åŠ äº‹ä»¶
                const resizeHandles = element.querySelectorAll('.resize-handle');
                resizeHandles.forEach(handle => {
                    handle.addEventListener('mousedown', handleResizeStart);
                });
            });

            // ä¸ºå¤é€‰æ¡†æ·»åŠ é€‰æ‹©äº‹ä»¶
            const excelCheckbox = document.getElementById('excel-checkbox');
            const wordCheckbox = document.getElementById('word-checkbox');
            const claudeCheckbox = document.getElementById('claude-checkbox');

            excelCheckbox.addEventListener('change', function(e) {
                handleCheckboxChange(excelContainer, e.target.checked);
                e.stopPropagation();
            });

            wordCheckbox.addEventListener('change', function(e) {
                handleCheckboxChange(wordContainer, e.target.checked);
                e.stopPropagation();
            });

            claudeCheckbox.addEventListener('change', function(e) {
                handleCheckboxChange(claudeContainer, e.target.checked);
                e.stopPropagation();
            });

            // é˜²æ­¢å¤é€‰æ¡†åŒºåŸŸè§¦å‘æ‹–æ‹½
            document.querySelectorAll('.document-checkbox').forEach(checkbox => {
                checkbox.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                });
            });

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            document.addEventListener('keydown', handleKeyDown);
            
            // ä¿®å¤åˆå§‹æ»šåŠ¨é—®é¢˜ï¼šç§»é™¤max-heighté™åˆ¶ï¼Œè®¾ç½®æ˜ç¡®çš„é«˜åº¦
            function fixInitialScrolling() {
                [excelContainer, wordContainer].forEach(container => {
                    if (container) {
                        // è·å–å½“å‰çš„è®¡ç®—é«˜åº¦
                        const rect = container.getBoundingClientRect();
                        const computedStyle = window.getComputedStyle(container);
                        const maxHeight = computedStyle.maxHeight;
                        
                        // å¦‚æœæœ‰max-heighté™åˆ¶ï¼Œå°†å…¶è½¬æ¢ä¸ºæ˜ç¡®çš„heightå€¼
                        if (maxHeight !== 'none') {
                            container.style.maxHeight = 'none';
                            container.style.height = rect.height + 'px';
                        }
                    }
                });
            }
            
            // åœ¨ä¸‹ä¸€å¸§æ‰§è¡Œä¿®å¤ï¼Œç¡®ä¿CSSå·²ç»åº”ç”¨
            requestAnimationFrame(fixInitialScrolling);
            
            // åˆå§‹åŒ–åä½œåŠ¨ç”»ç³»ç»Ÿ
            excelAnimator = new ExcelCollaborationAnimator();
            wordAnimator = new WordCollaborationAnimator();
            claudeAnimator = new ClaudeAIAnimator();
        });

        function handleCheckboxChange(container, isChecked) {
            if (isChecked) {
                selectDocument(container);
            } else {
                deselectDocument(container);
            }
        }

        function handleMouseDown(e) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†åŒºåŸŸï¼Œä¸å¯åŠ¨æ‹–æ‹½
            if (e.target.closest('.document-checkbox')) {
                return;
            }

            // å¦‚æœç‚¹å‡»çš„æ˜¯æ»šåŠ¨æ¡åŒºåŸŸï¼Œä¸å¯åŠ¨æ‹–æ‹½
            if (e.target.scrollHeight > e.target.clientHeight && 
                e.offsetX > e.target.clientWidth - 20) {
                return;
            }

            const element = e.currentTarget;
            mouseDownTarget = element;
            mouseDownPos.x = e.clientX;
            mouseDownPos.y = e.clientY;
            
            const rect = element.getBoundingClientRect();
            offset.x = e.clientX - rect.left;
            offset.y = e.clientY - rect.top;

            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (isResizing && currentResizeTarget) {
                performResize(e);
                return;
            }
            
            if (mouseDownTarget && !isDragging && !isResizing) {
                const deltaX = e.clientX - mouseDownPos.x;
                const deltaY = e.clientY - mouseDownPos.y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > DRAG_THRESHOLD) {
                    startDrag(mouseDownTarget);
                }
            }
            
            if (isDragging && currentElement) {
                drag(e);
            }
        }

        function handleMouseUp(e) {
            if (isResizing) {
                stopResize();
            } else if (isDragging) {
                stopDrag();
            }
            mouseDownTarget = null;
            mouseDownPos.x = 0;
            mouseDownPos.y = 0;
        }

        function selectDocument(element) {
            element.classList.add('selected');
            selectedDocuments.add(element);
            
            // åŒæ­¥å¤é€‰æ¡†çŠ¶æ€
            const checkbox = element.querySelector('.checkbox-input');
            if (checkbox) {
                checkbox.checked = true;
            }
            
            updateSelectionInfo();
        }

        function deselectDocument(element) {
            element.classList.remove('selected');
            selectedDocuments.delete(element);
            
            // åŒæ­¥å¤é€‰æ¡†çŠ¶æ€
            const checkbox = element.querySelector('.checkbox-input');
            if (checkbox) {
                checkbox.checked = false;
            }
            
            updateSelectionInfo();
        }

        function toggleSelection(element) {
            if (selectedDocuments.has(element)) {
                deselectDocument(element);
            } else {
                selectDocument(element);
            }
        }

        function clearAllSelections() {
            selectedDocuments.forEach(element => {
                element.classList.remove('selected');
                // åŒæ­¥å¤é€‰æ¡†çŠ¶æ€
                const checkbox = element.querySelector('.checkbox-input');
                if (checkbox) {
                    checkbox.checked = false;
                }
            });
            selectedDocuments.clear();
            updateSelectionInfo();
        }

        function updateSelectionInfo() {
            console.log(`Selected documents: ${selectedDocuments.size}`);
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„é€‰æ‹©çŠ¶æ€åé¦ˆ
        }

        function handleKeyDown(e) {
            // æŒ‰Escapeé”®å–æ¶ˆæ‰€æœ‰é€‰æ‹©
            if (e.key === 'Escape') {
                clearAllSelections();
            }
            // æŒ‰Ctrl+Aé€‰æ‹©æ‰€æœ‰æ–‡æ¡£
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                const excelContainer = document.querySelector('.excel-container');
                const wordContainer = document.querySelector('.word-container');
                const claudeContainer = document.getElementById('claudeOutputContainer');
                
                selectDocument(excelContainer);
                selectDocument(wordContainer);
                
                // åªæœ‰å½“Claudeå®¹å™¨å¯è§æ—¶æ‰é€‰æ‹©å®ƒ
                if (claudeContainer && claudeContainer.style.display !== 'none') {
                    selectDocument(claudeContainer);
                }
            }
        }

        function startDrag(element) {
            isDragging = true;
            currentElement = element;
            element.classList.add('dragging');
        }

        function drag(e) {
            if (!isDragging || !currentElement) return;
            
            e.preventDefault();
            
            const x = e.clientX - offset.x;
            const y = e.clientY - offset.y;
            
            // é™åˆ¶åœ¨ç”»å¸ƒèŒƒå›´å†…
            const maxX = window.innerWidth - currentElement.offsetWidth;
            const maxY = window.innerHeight - currentElement.offsetHeight;
            
            const boundedX = Math.max(0, Math.min(x, maxX));
            const boundedY = Math.max(0, Math.min(y, maxY));
            
            currentElement.style.left = boundedX + 'px';
            currentElement.style.top = boundedY + 'px';
        }

        function stopDrag() {
            if (currentElement) {
                currentElement.classList.remove('dragging');
                currentElement = null;
            }
            isDragging = false;
        }

        // è°ƒæ•´å¤§å°ç›¸å…³å‡½æ•°
        function handleResizeStart(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isResizing = true;
            currentResizeTarget = e.target.closest('.excel-container, .word-container, .claude-output-container');
            
            // ç¡®å®šè°ƒæ•´æ–¹å‘
            if (e.target.classList.contains('resize-handle-se')) {
                resizeDirection = 'se';
            } else if (e.target.classList.contains('resize-handle-e')) {
                resizeDirection = 'e';
            } else if (e.target.classList.contains('resize-handle-s')) {
                resizeDirection = 's';
            }
            
            // è®°å½•åˆå§‹ä½ç½®å’Œå°ºå¯¸
            const rect = currentResizeTarget.getBoundingClientRect();
            originalRect = {
                width: rect.width,
                height: rect.height,
                left: rect.left,
                top: rect.top
            };
            
            startPos = {
                x: e.clientX,
                y: e.clientY
            };
            
            // æ·»åŠ è°ƒæ•´å¤§å°çŠ¶æ€çš„æ ·å¼
            currentResizeTarget.style.userSelect = 'none';
            currentResizeTarget.classList.add('resizing'); // æ·»åŠ è°ƒæ•´å¤§å°çŠ¶æ€ç±»
            document.body.style.cursor = e.target.style.cursor;
            
            // ä¸´æ—¶ç§»é™¤CSSçš„é«˜åº¦é™åˆ¶ï¼Œå…è®¸è‡ªç”±è°ƒæ•´å¤§å°
            currentResizeTarget.style.maxHeight = 'none';
            currentResizeTarget.style.height = rect.height + 'px';
        }

        function performResize(e) {
            if (!isResizing || !currentResizeTarget) return;
            
            const deltaX = e.clientX - startPos.x;
            const deltaY = e.clientY - startPos.y;
            
            let newWidth = originalRect.width;
            let newHeight = originalRect.height;
            
            if (resizeDirection === 'se' || resizeDirection === 'e') {
                newWidth = Math.max(200, originalRect.width + deltaX);
            }
            
            if (resizeDirection === 'se' || resizeDirection === 's') {
                newHeight = Math.max(150, originalRect.height + deltaY);
            }
            
            // ç¡®ä¿ä¸è¶…å‡ºè§†çª—è¾¹ç•Œ
            const maxWidth = window.innerWidth - originalRect.left - 20;
            const maxHeight = window.innerHeight - originalRect.top - 20;
            
            newWidth = Math.min(newWidth, maxWidth);
            newHeight = Math.min(newHeight, maxHeight);
            
            currentResizeTarget.style.width = newWidth + 'px';
            currentResizeTarget.style.height = newHeight + 'px';
        }

        function stopResize() {
            if (currentResizeTarget) {
                currentResizeTarget.style.userSelect = '';
                currentResizeTarget.classList.remove('resizing'); // ç§»é™¤è°ƒæ•´å¤§å°çŠ¶æ€ç±»
                // ä¸æ¢å¤max-heighté™åˆ¶ï¼Œä¿æŒç”¨æˆ·è°ƒæ•´åçš„å¤§å°
                // è¿™æ ·ç”¨æˆ·å°±å¯ä»¥è‡ªç”±è°ƒæ•´å®¹å™¨å¤§å°è€Œä¸å—CSSé™åˆ¶
                currentResizeTarget = null;
            }
            
            document.body.style.cursor = '';
            isResizing = false;
            resizeDirection = null;
        }
    </script>
    
    <!-- å…¨å±€åŠ¨ç”»æ§åˆ¶å¼€å…³ -->
    <div class="global-animation-control">
        <i class="fas fa-play icon"></i>
        <div class="global-animation-toggle active" id="globalAnimationToggle">
            <div class="slider"></div>
        </div>
    </div>
</body>
</html>
